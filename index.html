<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0c0f14">
<link rel="manifest" href="manifest.json">
<title>Log Splitter â€” Phoenix Nest</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0c0f14; --bg2:#12161e; --bg3:#1a1f2b; --bg4:#232a38;
  --fg:#e2e6ed; --fg2:#9aa3b4; --fg3:#5e6778;
  --accent:#e8984a; --accent2:#f0b06e;
  --blue:#4a9eed; --green:#4ecb71; --red:#e85454;
  --yellow:#f0d24a; --cyan:#4ec9b0;
  --mono:'JetBrains Mono',monospace; --font:'Outfit',sans-serif;
  --radius:10px; --safe-b:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--bg);color:var(--fg);display:flex;flex-direction:column;touch-action:pan-y}

.header{background:var(--bg2);border-bottom:1px solid var(--bg4);padding:.6rem 1rem;display:flex;align-items:center;gap:.6rem;flex-shrink:0}
.header .logo{font-size:1.4rem}
.header h1{font-family:var(--mono);font-size:.85rem;font-weight:600;color:var(--accent);letter-spacing:.03em}
.header .sub{font-size:.65rem;color:var(--fg3);font-family:var(--mono)}

.tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--bg4);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{flex:1;min-width:0;padding:.6rem .4rem;text-align:center;font-family:var(--mono);font-size:.65rem;font-weight:500;color:var(--fg3);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);background:var(--bg)}
.tab:hover:not(.active){color:var(--fg2)}
.tab-icon{font-size:1.1rem;display:block;margin-bottom:.15rem}

.content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(1rem + var(--safe-b))}
.panel{display:none;padding:1rem}
.panel.active{display:block}

.card{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.8rem;margin-bottom:.6rem}
.card-title{font-family:var(--mono);font-size:.72rem;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem}
.section-title{font-family:var(--mono);font-size:.8rem;font-weight:700;color:var(--fg);margin:1rem 0 .5rem;padding-bottom:.3rem;border-bottom:1px solid var(--bg4)}

.search-box{width:100%;padding:.55rem .7rem;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;color:var(--fg);font-family:var(--mono);font-size:.78rem;margin-bottom:.6rem}
.search-box:focus{border-color:var(--accent);outline:none}
.search-box::placeholder{color:var(--fg3)}

@keyframes fadeSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:4px}

.install-phase{margin-bottom:1rem}
.phase-header{display:flex;align-items:center;gap:.5rem;padding:.6rem .7rem;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;cursor:pointer;user-select:none;-webkit-user-select:none;transition:all .15s}
.phase-header:active{background:var(--bg4)}
.phase-header .phase-icon{font-size:1.2rem}
.phase-header .phase-title{font-family:var(--mono);font-size:.78rem;font-weight:600;color:var(--fg);flex:1}
.phase-header .phase-count{font-family:var(--mono);font-size:.6rem;color:var(--fg3)}
.phase-header .phase-arrow{color:var(--fg3);transition:transform .2s;font-size:.8rem}
.phase-header.open .phase-arrow{transform:rotate(90deg)}
.phase-header.open{border-color:var(--accent);background:var(--bg2)}
.phase-header.done{border-color:var(--green);opacity:.7}
.phase-header.done .phase-title{color:var(--green)}

.phase-steps{display:none;padding:.4rem 0 0}
.phase-steps.open{display:block}

.inst-step{background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;padding:.65rem .7rem;margin-bottom:.35rem;transition:all .15s}
.inst-step.completed{opacity:.5;border-color:var(--green)}
.inst-step.completed .step-action{text-decoration:line-through;text-decoration-color:var(--fg3)}

.step-top{display:flex;align-items:flex-start;gap:.5rem}
.step-check{width:22px;height:22px;border:2px solid var(--bg4);border-radius:5px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;margin-top:.05rem;font-size:.7rem;color:transparent}
.step-check:hover{border-color:var(--accent)}
.step-check.checked{background:var(--green);border-color:var(--green);color:var(--bg)}

.step-num{font-family:var(--mono);font-size:.7rem;font-weight:600;color:var(--accent);min-width:28px;flex-shrink:0;margin-top:.05rem}
.step-action{font-size:.78rem;color:var(--fg);line-height:1.5;flex:1}
.step-action .wire-ref{font-family:var(--mono);font-weight:600;color:var(--cyan);font-size:.74rem}
.step-warn{color:var(--yellow);font-weight:600}

.step-test{background:var(--bg3);border-left:3px solid var(--yellow);border-radius:0 8px 8px 0;padding:.55rem .7rem;margin:.35rem 0 0 30px;font-size:.74rem;line-height:1.6;color:var(--fg2);animation:fadeSlide .2s ease}
.step-test .test-title{font-family:var(--mono);font-size:.65rem;font-weight:600;color:var(--yellow);margin-bottom:.25rem}
.step-test .test-line{margin-bottom:.15rem}
.step-test .expected{color:var(--green);font-weight:500}
.step-test .if-fail{color:var(--red)}

.install-progress{background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;padding:.5rem .7rem;margin-bottom:.8rem;display:flex;align-items:center;gap:.6rem}
.prog-bar-wrap{flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden}
.prog-bar{height:100%;background:var(--green);border-radius:3px;transition:width .3s}
.prog-text{font-family:var(--mono);font-size:.65rem;color:var(--fg3);min-width:42px;text-align:right}

.tbl{width:100%;border-collapse:collapse;font-size:.72rem}
.tbl th{background:var(--bg4);color:var(--accent);font-family:var(--mono);font-weight:600;font-size:.65rem;text-transform:uppercase;letter-spacing:.04em;padding:.5rem .4rem;text-align:left;position:sticky;top:0;z-index:2}
.tbl td{padding:.45rem .4rem;border-bottom:1px solid var(--bg3);color:var(--fg2);vertical-align:top}
.tbl tr:hover td{background:var(--bg3)}
.tbl .wire-id{font-family:var(--mono);font-weight:600;color:var(--fg)}
.tbl .wire-red{color:var(--red);font-weight:600}
.tbl .wire-blk{color:var(--fg);font-weight:600}
.tbl .wire-grn{color:var(--green);font-weight:600}
.tbl .unused{color:var(--fg3);font-style:italic}

.tracer-select{width:100%;padding:.55rem .6rem;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;color:var(--fg);font-family:var(--mono);font-size:.78rem;appearance:none;cursor:pointer;margin-bottom:.8rem}
.tracer-select:focus{border-color:var(--accent);outline:none}
.trace-path{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.7rem;margin-bottom:.5rem}
.trace-label{font-size:.7rem;color:var(--fg3);margin-bottom:.4rem;font-family:var(--mono);font-weight:500}
.trace-flow{display:flex;flex-wrap:wrap;align-items:center;gap:.25rem;line-height:2}
.trace-component{display:inline-block;padding:.2rem .5rem;border-radius:5px;font-family:var(--mono);font-size:.72rem;font-weight:600}
.trace-wire{display:inline-block;padding:.15rem .4rem;border-radius:4px;font-family:var(--mono);font-size:.68rem;font-weight:500;background:var(--bg4);color:var(--fg2)}
.trace-arrow{color:var(--fg3);font-size:.7rem}

.comp-power{background:#3a1a1a;color:var(--red);border:1px solid #5a2a2a}
.comp-switch{background:#1a2a3a;color:var(--blue);border:1px solid #2a3a5a}
.comp-relay{background:#2a2a1a;color:var(--yellow);border:1px solid #4a4a2a}
.comp-solenoid{background:#1a3a1a;color:var(--green);border:1px solid #2a5a2a}
.comp-ground{background:#1a1a1a;color:var(--fg3);border:1px solid #3a3a3a}

.trace-note{font-size:.7rem;color:var(--yellow);margin-top:.4rem;padding:.4rem;background:var(--bg3);border-radius:6px}
.trace-circuits{font-size:.72rem;color:var(--fg3);margin-top:.3rem}
.trace-circuits strong{color:var(--fg2)}

.ts-breadcrumb{font-family:var(--mono);font-size:.6rem;color:var(--fg3);margin-bottom:.6rem;display:flex;flex-wrap:wrap;gap:.2rem}
.ts-breadcrumb span{cursor:pointer}
.ts-breadcrumb span:hover{color:var(--accent)}
.ts-breadcrumb .sep{color:var(--bg4);cursor:default}

.ts-node{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.8rem;margin-bottom:.4rem;animation:fadeSlide .25s ease}
.ts-question{font-size:.82rem;font-weight:500;color:var(--fg);margin-bottom:.6rem;line-height:1.5}
.ts-options{display:flex;flex-direction:column;gap:.35rem}

.ts-btn{display:block;width:100%;padding:.65rem .8rem;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;color:var(--fg);font-family:var(--font);font-size:.78rem;text-align:left;cursor:pointer;transition:all .15s;line-height:1.4}
.ts-btn:hover,.ts-btn:active{background:var(--bg4);border-color:var(--accent)}

.ts-answer{background:var(--bg3);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;padding:.7rem .8rem;margin-bottom:.4rem;font-size:.78rem;line-height:1.6;color:var(--fg2);animation:fadeSlide .25s ease}
.ts-answer strong{color:var(--fg);display:block;margin-bottom:.3rem;font-size:.84rem}
.ts-answer .line{margin-bottom:.3rem}
.ts-answer .fix{color:var(--green);font-weight:500}
.ts-answer .warn{color:var(--yellow);font-weight:500}
.ts-answer .trace{color:var(--cyan);font-family:var(--mono);font-size:.72rem;background:var(--bg4);padding:.3rem .5rem;border-radius:5px;display:block;margin:.3rem 0;word-break:break-all}

.ts-restart{display:block;width:100%;margin-top:.6rem;padding:.6rem;background:none;border:1px dashed var(--fg3);border-radius:8px;color:var(--fg3);font-family:var(--mono);font-size:.7rem;cursor:pointer;text-align:center}
.ts-restart:hover{border-color:var(--accent);color:var(--accent)}

.sim-controls{display:flex;gap:.4rem;margin-bottom:.8rem;flex-wrap:wrap}
.sim-btn{padding:.55rem .8rem;border-radius:8px;border:1px solid var(--bg4);background:var(--bg3);color:var(--fg);font-family:var(--mono);font-size:.72rem;font-weight:500;cursor:pointer;transition:all .15s;flex:1;min-width:70px;text-align:center;user-select:none;-webkit-user-select:none}
.sim-btn:active{transform:scale(.97)}
.sim-btn.active-fwd{background:#2a1a1a;border-color:var(--red);color:var(--red)}
.sim-btn.active-bwd{background:#1a2a1a;border-color:var(--green);color:var(--green)}
.sim-btn.active-cycle{background:#2a2a1a;border-color:var(--yellow);color:var(--yellow)}
.sim-btn.active-estop{background:#3a1a1a;border-color:var(--red);color:var(--red)}

.sim-status{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.6rem;margin-bottom:.5rem;font-family:var(--mono);font-size:.72rem;color:var(--fg2);text-align:center;min-height:2.8rem;display:flex;align-items:center;justify-content:center;line-height:1.4}
.sim-status .state{color:var(--accent);font-weight:600}

.sim-grid{display:grid;grid-template-columns:1fr 1fr;gap:.4rem}
.sim-item{background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;padding:.5rem .6rem;display:flex;align-items:center;gap:.5rem;transition:all .3s}
.sim-item.on{border-color:var(--green);background:#0f1a14}
.sim-item.on .sim-dot{background:var(--green);box-shadow:0 0 8px var(--green)}
.sim-item.off .sim-dot{background:var(--fg3);opacity:.4}
.sim-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;transition:all .3s}
.sim-label{font-family:var(--mono);font-size:.7rem;font-weight:600;color:var(--fg)}
.sim-sublabel{font-size:.6rem;color:var(--fg3);font-weight:400}
.sim-item.on .sim-label{color:var(--green)}

.sim-cylinder{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.8rem;margin-top:.5rem}
.cyl-title{font-family:var(--mono);font-size:.65rem;color:var(--fg3);margin-bottom:.3rem}
.cyl-track{height:34px;background:var(--bg4);border-radius:6px;position:relative;overflow:hidden;margin:.3rem 0}
.cyl-rod{position:absolute;left:0;top:0;bottom:0;width:10%;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:6px;transition:width .08s linear;min-width:10%}
.cyl-labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.6rem;color:var(--fg3);margin-top:.2rem}
.cyl-ls{font-weight:600;padding:.15rem .35rem;border-radius:4px;transition:all .3s}
.cyl-ls.active{background:var(--green);color:var(--bg)}

</style>
</head>
<body>

<div class="header">
  <span class="logo">âš¡</span>
  <div>
    <h1>LOG SPLITTER</h1>
    <div class="sub">PN-LS-002 Â· Phoenix Nest LLC</div>
  </div>
</div>

<div class="tabs">
  <button class="tab active" data-tab="install"><span class="tab-icon">ðŸ”¨</span>Install</button>
  <button class="tab" data-tab="troubleshoot"><span class="tab-icon">ðŸ”§</span>Troubleshoot</button>
  <button class="tab" data-tab="wiring"><span class="tab-icon">ðŸ“‹</span>Wiring</button>
  <button class="tab" data-tab="tracer"><span class="tab-icon">âš¡</span>Tracer</button>
  <button class="tab" data-tab="simulator"><span class="tab-icon">â–¶</span>Simulator</button>
</div>

<div class="content">

  <!-- INSTALL -->
  <div class="panel active" id="install">
    <div class="card-title">Installation Guide</div>
    <p style="font-size:.75rem;color:var(--fg3);margin-bottom:.6rem">Wire and test one circuit at a time. Check off each step as you go.</p>
    <div id="install-content"></div>
  </div>

  <!-- TROUBLESHOOT -->
  <div class="panel" id="troubleshoot">
    <div class="ts-breadcrumb" id="ts-breadcrumb"></div>
    <div id="ts-flow"></div>
  </div>

  <!-- WIRING -->
  <div class="panel" id="wiring">
    <input class="search-box" id="wire-search" type="text" placeholder="Search wires, pins, components...">
    <div class="section-title">Wire Schedule (W01â€“W25)</div>
    <div style="overflow-x:auto">
      <table class="tbl" id="wire-table">
        <thead><tr><th>ID</th><th>Color</th><th>AWG</th><th>From â†’ To</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="section-title" style="margin-top:1rem">K1 â€” Cycle Latch Relay</div>
    <div id="k1-table" style="overflow-x:auto"></div>
    <div class="section-title" style="margin-top:1rem">K2 â€” Direction Relay</div>
    <div id="k2-table" style="overflow-x:auto"></div>
    <div class="section-title" style="margin-top:1rem">Flyback Diodes</div>
    <div class="card">
      <div style="font-size:.78rem;color:var(--fg2);line-height:1.7">
        <strong style="color:var(--red)">D1</strong> across SOL-A &nbsp;Â·&nbsp;
        <strong style="color:var(--red)">D2</strong> across SOL-B &nbsp;Â·&nbsp;
        <strong style="color:var(--red)">D3</strong> across K1 (pins 2/7) &nbsp;Â·&nbsp;
        <strong style="color:var(--red)">D4</strong> across K2 (pins 2/7)<br>
        <span style="color:var(--yellow)">âš  Cathode band (stripe) toward (+) terminal on ALL diodes. Reversed = dead short = blown fuse.</span>
      </div>
    </div>
  </div>

  <!-- TRACER -->
  <div class="panel" id="tracer">
    <div class="card-title">Circuit Tracer</div>
    <p style="font-size:.75rem;color:var(--fg3);margin-bottom:.6rem">Select a wire or circuit to trace the complete current path.</p>
    <select class="tracer-select" id="trace-select">
      <optgroup label="Circuits">
        <option value="power">Power Bus</option>
        <option value="fwd">Manual FWD Jog</option>
        <option value="bwd">Manual BWD Jog</option>
        <option value="k1">K1 Coil (Cycle Latch)</option>
        <option value="k2">K2 Coil (Direction)</option>
        <option value="k2_extend">K2 â†’ SOL-A (Extend)</option>
        <option value="k2_retract">K2 â†’ SOL-B (Retract)</option>
      </optgroup>
      <optgroup label="Individual Wires" id="trace-wire-opts"></optgroup>
    </select>
    <div id="trace-result"></div>
  </div>

  <!-- SIMULATOR -->
  <div class="panel" id="simulator">
    <div class="card-title">Cycle Simulator</div>
    <p style="font-size:.75rem;color:var(--fg3);margin-bottom:.6rem">Tap buttons to simulate. Hold FWD/BWD to jog.</p>
    <div class="sim-controls">
      <button class="sim-btn" id="sim-fwd">â–¶ FWD</button>
      <button class="sim-btn" id="sim-bwd">â—€ BWD</button>
      <button class="sim-btn" id="sim-cycle">âŸ³ CYCLE</button>
      <button class="sim-btn" id="sim-estop">â›” E-STOP</button>
    </div>
    <div class="sim-status" id="sim-status"><span class="state">IDLE</span> â€” Ready</div>
    <div class="sim-grid">
      <div class="sim-item off" id="si-k1"><div class="sim-dot"></div><div><div class="sim-label">K1</div><div class="sim-sublabel">Cycle Latch</div></div></div>
      <div class="sim-item off" id="si-k2"><div class="sim-dot"></div><div><div class="sim-label">K2</div><div class="sim-sublabel">Direction</div></div></div>
      <div class="sim-item off" id="si-sola"><div class="sim-dot"></div><div><div class="sim-label">SOL-A</div><div class="sim-sublabel">Extend</div></div></div>
      <div class="sim-item off" id="si-solb"><div class="sim-dot"></div><div><div class="sim-label">SOL-B</div><div class="sim-sublabel">Retract</div></div></div>
      <div class="sim-item off" id="si-ls1"><div class="sim-dot"></div><div><div class="sim-label">LS1</div><div class="sim-sublabel">Full Extend</div></div></div>
      <div class="sim-item off" id="si-ls2"><div class="sim-dot"></div><div><div class="sim-label">LS2</div><div class="sim-sublabel">Home</div></div></div>
    </div>
    <div class="sim-cylinder">
      <div class="cyl-title">CYLINDER POSITION</div>
      <div class="cyl-track"><div class="cyl-rod" id="cyl-rod"></div></div>
      <div class="cyl-labels">
        <span class="cyl-ls" id="cyl-ls2">LS2 HOME</span>
        <span>stroke â†’</span>
        <span class="cyl-ls" id="cyl-ls1">LS1 EXTEND</span>
      </div>
    </div>
  </div>

</div>

<script>
const WIRES = [
  {id:"W01",desc:"BATT(+) to Fuse",color:"RED",awg:"12",from:"Battery (+)",to:"Fuse input"},
  {id:"W02",desc:"Fuse to E-Stop",color:"RED",awg:"12",from:"Fuse output",to:"E-Stop NC (C1)"},
  {id:"W03",desc:"E-Stop to Bus A",color:"RED",awg:"12",from:"E-Stop NC (C2)",to:"+12V Bus (A)"},
  {id:"W04",desc:"Bus A to FWD btn",color:"RED",awg:"14",from:"+12V Bus (A)",to:"FWD term 1"},
  {id:"W05",desc:"FWD to SOL-A",color:"RED",awg:"14",from:"FWD term 2",to:"SOL-A (+)"},
  {id:"W06",desc:"SOL-A to GND",color:"BLK",awg:"14",from:"SOL-A (âˆ’)",to:"Ground bus"},
  {id:"W07",desc:"Bus A to BWD btn",color:"RED",awg:"14",from:"+12V Bus (A)",to:"BWD term 1"},
  {id:"W08",desc:"BWD to SOL-B",color:"RED",awg:"14",from:"BWD term 2",to:"SOL-B (+)"},
  {id:"W09",desc:"SOL-B to GND",color:"BLK",awg:"14",from:"SOL-B (âˆ’)",to:"Ground bus"},
  {id:"W10",desc:"Bus A to CYCLE btn",color:"RED",awg:"14",from:"+12V Bus (A)",to:"CYCLE term 1"},
  {id:"W11",desc:"CYCLE to Jct B",color:"RED",awg:"16",from:"CYCLE term 2",to:"Junction B"},
  {id:"W12",desc:"Bus A to K1 pin 1",color:"RED",awg:"16",from:"+12V Bus (A)",to:"K1 pin 1 (COM)"},
  {id:"W13",desc:"K1 pin 4 to Jct B",color:"RED",awg:"16",from:"K1 pin 4 (NO)",to:"Junction B"},
  {id:"W14",desc:"Jct B to LS2",color:"RED",awg:"16",from:"Junction B",to:"LS2 term 1"},
  {id:"W15",desc:"LS2 to K1 coil",color:"RED",awg:"16",from:"LS2 term 2",to:"K1 pin 2 (+)"},
  {id:"W16",desc:"K1 coil to GND",color:"BLK",awg:"16",from:"K1 pin 7 (âˆ’)",to:"Ground bus"},
  {id:"W17",desc:"Bus A to K1 pin 8",color:"RED",awg:"14",from:"+12V Bus (A)",to:"K1 pin 8 (COM)"},
  {id:"W18",desc:"K1 pin 5 to LS1",color:"RED",awg:"16",from:"K1 pin 5 (NO)",to:"LS1 term 1"},
  {id:"W19",desc:"LS1 to K2 coil",color:"RED",awg:"16",from:"LS1 term 2",to:"K2 pin 2 (+)"},
  {id:"W20",desc:"K2 coil to GND",color:"BLK",awg:"16",from:"K2 pin 7 (âˆ’)",to:"Ground bus"},
  {id:"W21",desc:"Bus A to K2 pin 1",color:"RED",awg:"14",from:"+12V Bus (A)",to:"K2 pin 1 (COM)"},
  {id:"W22",desc:"K2 NO to SOL-A",color:"GRN",awg:"14",from:"K2 pin 4 (NO)",to:"SOL-A (+)"},
  {id:"W23",desc:"K2 NC to SOL-B",color:"GRN",awg:"14",from:"K2 pin 3 (NC)",to:"SOL-B (+)"},
  {id:"W24",desc:"BATT(âˆ’) to GND bus",color:"BLK",awg:"12",from:"Battery (âˆ’)",to:"Ground bus"},
  {id:"W25",desc:"GND bus to Chassis",color:"BLK",awg:"12",from:"Ground bus",to:"Frame bolt"},
];

const CIRCUITS = {
  power: {
    label: "Power Bus",
    path: [
      {type:"power",name:"BATT(+)"},{wire:"W01"},{type:"power",name:"FUSE 15A"},{wire:"W02"},
      {type:"switch",name:"E-STOP NC"},{wire:"W03"},{type:"power",name:"+12V BUS (A)"}
    ]
  },
  fwd: {
    label: "Manual FWD Jog â†’ SOL-A",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W04"},{type:"switch",name:"FWD btn"},{wire:"W05"},
      {type:"solenoid",name:"SOL-A"},{wire:"W06"},{type:"ground",name:"GND"}
    ]
  },
  bwd: {
    label: "Manual BWD Jog â†’ SOL-B",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W07"},{type:"switch",name:"BWD btn"},{wire:"W08"},
      {type:"solenoid",name:"SOL-B"},{wire:"W09"},{type:"ground",name:"GND"}
    ]
  },
  k1: {
    label: "K1 Coil (Cycle Latch)",
    note: "Parallel paths: CYCLE btn (W10â†’W11) OR K1-1 seal (W12â†’pin1â†’pin4â†’W13) both reach Junction B",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W10"},{type:"switch",name:"CYCLE btn"},{wire:"W11"},
      {type:"relay",name:"Jct B"},{wire:"W14"},{type:"switch",name:"LS2 NC"},{wire:"W15"},
      {type:"relay",name:"K1 COIL"},{wire:"W16"},{type:"ground",name:"GND"}
    ],
    alt: {
      label: "Seal Path (parallel to CYCLE btn)",
      path: [
        {type:"power",name:"BUS (A)"},{wire:"W12"},{type:"relay",name:"K1-1 COMâ†’NO"},{wire:"W13"},
        {type:"relay",name:"Jct B"}
      ]
    }
  },
  k2: {
    label: "K2 Coil (Direction)",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W17"},{type:"relay",name:"K1-2 COMâ†’NO"},{wire:"W18"},
      {type:"switch",name:"LS1 NC"},{wire:"W19"},{type:"relay",name:"K2 COIL"},{wire:"W20"},
      {type:"ground",name:"GND"}
    ]
  },
  k2_extend: {
    label: "K2 Output â†’ SOL-A (K2 Energized)",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W21"},{type:"relay",name:"K2-1 COMâ†’NO"},{wire:"W22"},
      {type:"solenoid",name:"SOL-A"},{wire:"W06"},{type:"ground",name:"GND"}
    ]
  },
  k2_retract: {
    label: "K2 Output â†’ SOL-B (K2 De-energized)",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W21"},{type:"relay",name:"K2-1 COMâ†’NC"},{wire:"W23"},
      {type:"solenoid",name:"SOL-B"},{wire:"W09"},{type:"ground",name:"GND"}
    ]
  }
};

function findCircuitsForWire(wireId) {
  const found = [];
  for (const [k, v] of Object.entries(CIRCUITS)) {
    if (v.path.some(s => s.wire === wireId)) found.push(v.label);
    if (v.alt && v.alt.path.some(s => s.wire === wireId)) found.push(v.alt.label);
  }
  return found;
}

const TS_TREE = {
  start: {
    q: "ðŸ”§ What's the problem?",
    opts: [
      {label: "Nothing works â€” completely dead", next: "dead1"},
      {label: "FWD jog doesn't work", next: "fwd1"},
      {label: "BWD jog doesn't work", next: "bwd1"},
      {label: "CYCLE button does nothing", next: "cyc1"},
      {label: "Extends but won't auto-retract", next: "noret1"},
      {label: "Retracts but won't stop at home", next: "nostop1"},
      {label: "Fuse keeps blowing", next: "fuse1"},
      {label: "Relay chatters or buzzes", next: "chatter1"},
      {label: "Solenoid hums, no cylinder movement", next: "hyd1"},
    ]
  },

  // === DEAD SYSTEM ===
  dead1: {
    q: "âš¡ Measure battery voltage with a multimeter.",
    opts: [
      {label: "Less than 11V", next: "dead_batt"},
      {label: "12V+ at battery terminals", next: "dead2"},
    ]
  },
  dead_batt: {
    answer: "Battery is dead or weak.|FIX: Charge or replace battery. Check for parasitic draw if it keeps dying."
  },
  dead2: {
    q: "Check the fuse. Is it blown?",
    opts: [
      {label: "Fuse is blown", next: "dead_fuse"},
      {label: "Fuse is good", next: "dead3"},
    ]
  },
  dead_fuse: {
    answer: "Blown fuse = short circuit somewhere.|Do NOT just replace the fuse. Disconnect all loads from Bus (A). Reconnect one at a time to isolate the short.|Most common cause: reversed flyback diode (D1-D4). Check cathode band orientation on all four."
  },
  dead3: {
    q: "Is the E-Stop pressed in (locked)?",
    opts: [
      {label: "Yes â€” it's pressed in", next: "dead_estop"},
      {label: "No â€” E-Stop is released", next: "dead4"},
    ]
  },
  dead_estop: {
    answer: "FIX: Twist the E-Stop to release it.|Power should restore to Bus (A). Verify with multimeter."
  },
  dead4: {
    q: "Measure voltage at +12V Bus (A) terminal block.",
    opts: [
      {label: "0V at Bus (A)", next: "dead_bus"},
      {label: "~12V at Bus (A)", next: "dead_busok"},
    ]
  },
  dead_bus: {
    answer: "Power not reaching Bus (A).|TRACE: BATT(+) â†’ W01 â†’ FUSE â†’ W02 â†’ E-STOP NC â†’ W03 â†’ Bus (A)|Check each wire and terminal for continuity. Look for corroded terminals, loose crimps, or broken wire."
  },
  dead_busok: {
    answer: "Bus (A) has power â€” problem is downstream.|Go back and select a more specific symptom (FWD, CYCLE, etc.) to narrow it down."
  },

  // === FWD JOG ===
  fwd1: {
    q: "Hold FWD. Measure voltage at FWD button output terminal.",
    opts: [
      {label: "0V at FWD output", next: "fwd_nopower"},
      {label: "~12V at FWD output", next: "fwd2"},
    ]
  },
  fwd_nopower: {
    answer: "No power through FWD button.|CHECK: W04 from Bus (A) to FWD terminal 1. Verify button is NO type.|Measure at FWD terminal 1 â€” if 12V there but 0V at terminal 2 when pressed â†’ button is bad."
  },
  fwd2: {
    q: "Listen at SOL-A. Does it click when FWD is pressed?",
    opts: [
      {label: "No click from SOL-A", next: "fwd_nosol"},
      {label: "SOL-A clicks but cylinder doesn't move", next: "hyd1"},
    ]
  },
  fwd_nosol: {
    answer: "Power not reaching SOL-A or coil is dead.|CHECK: W05 (FWD â†’ SOL-A+) and W06 (SOL-Aâˆ’ â†’ GND).|WARNING: If D1 is backwards it's a dead short â€” fuse should blow. Check diode orientation.|Test: swap SOL-A and SOL-B connections briefly to see if SOL-A coil itself is dead."
  },

  // === BWD JOG ===
  bwd1: {
    answer: "Same diagnostic as FWD but for retract circuit.|CHECK: W07 (Bus A â†’ BWD), W08 (BWD â†’ SOL-B+), W09 (SOL-Bâˆ’ â†’ GND), D2 orientation.|If BWD works but FWD doesn't (or vice versa), the problem is isolated to that specific button/solenoid/wire path."
  },

  // === CYCLE ===
  cyc1: {
    q: "Is the cylinder at HOME (fully retracted)?",
    opts: [
      {label: "No â€” cylinder is out or mid-stroke", next: "cyc_nothome"},
      {label: "Yes â€” fully retracted at home", next: "cyc2"},
    ]
  },
  cyc_nothome: {
    answer: "FIX: Jog cylinder to HOME using BWD button.|LS2 must be closed (cylinder at home) for CYCLE to work. K1 cannot latch if LS2 is open."
  },
  cyc2: {
    q: "Press CYCLE. Does K1 relay click?",
    opts: [
      {label: "K1 does NOT click", next: "cyc_nok1"},
      {label: "K1 clicks ON", next: "cyc3"},
    ]
  },
  cyc_nok1: {
    answer: "K1 coil not energizing.|TRACE while holding CYCLE: Bus(A) â†’ W10 â†’ CYCLE btn â†’ W11 â†’ Jct B â†’ W14 â†’ LS2 â†’ W15 â†’ K1 pin 2|Measure voltage at K1 pin 2 while holding CYCLE. If 12V there â†’ check W16 (pin 7 â†’ GND). If 0V â†’ work backwards to find open connection."
  },
  cyc3: {
    q: "Release CYCLE. Does K1 stay latched?",
    opts: [
      {label: "K1 drops when I release", next: "cyc_noseal"},
      {label: "K1 stays ON â€” latched", next: "cyc4"},
    ]
  },
  cyc_noseal: {
    answer: "Seal contact (K1-1) not holding.|CHECK: W12 (Bus A â†’ K1 pin 1 COM) and W13 (K1 pin 4 NO â†’ Junction B).|Verify pin 1 = COM and pin 4 = NO on your specific relay. Use continuity test with K1 energized to confirm contact closes."
  },
  cyc4: {
    q: "Does K2 click on when K1 latches?",
    opts: [
      {label: "K2 does NOT click", next: "cyc_nok2"},
      {label: "K2 clicks ON â€” both relays on", next: "cyc5"},
    ]
  },
  cyc_nok2: {
    answer: "K2 coil not energizing.|TRACE: Bus(A) â†’ W17 â†’ K1 pin 8 (COM) â†’ pin 5 (NO) â†’ W18 â†’ LS1 â†’ W19 â†’ K2 pin 2|K1-2 must be closed (K1 latched) and LS1 must be closed (not at full extend). Check W17, W18, W19, W20."
  },
  cyc5: {
    q: "Does the cylinder start extending?",
    opts: [
      {label: "No movement", next: "cyc_nomove"},
      {label: "Yes â€” extends fine", next: "cyc_ok"},
    ]
  },
  cyc_nomove: {
    answer: "K2 output not reaching SOL-A.|CHECK: W21 (Bus A â†’ K2 pin 1 COM), W22 (K2 pin 4 NO â†’ SOL-A+).|Verify pin 4 = NO on your relay. When K2 energized, pin 1 should connect to pin 4.|Also confirm SOL-A ground W06 is connected."
  },
  cyc_ok: {
    answer: "Cycle is starting correctly!|If the problem is with the return stroke, go back and select 'Extends but won't auto-retract'."
  },

  // === NO AUTO-RETRACT ===
  noret1: {
    q: "At full extend, does LS1 actuate? (listen for click)",
    opts: [
      {label: "LS1 does NOT click", next: "noret_ls1"},
      {label: "LS1 clicks but K2 stays on", next: "noret_wiring"},
      {label: "LS1 clicks, K2 drops, but SOL-B doesn't fire", next: "noret_solb"},
    ]
  },
  noret_ls1: {
    answer: "LS1 not being activated at full extend.|FIX: Adjust LS1 mounting position. The cylinder rod/wedge must physically trigger LS1. Jog slowly with FWD and watch."
  },
  noret_wiring: {
    answer: "LS1 may be wired NO instead of NC.|LS1 MUST be NC (closed at rest, opens when hit). If wired to the NO terminal of the switch, swap to NC terminal.|With switch not actuated, you should have continuity across the two wired terminals."
  },
  noret_solb: {
    answer: "K2 dropped but SOL-B not firing on the NC path.|CHECK: W23 (K2 pin 3 NC â†’ SOL-B+). When K2 de-energized, pin 1 (COM) connects to pin 3 (NC).|Verify pin 3 = NC on your relay. Also check SOL-B ground (W09)."
  },

  // === NO STOP AT HOME ===
  nostop1: {
    q: "When cylinder reaches home, does LS2 actuate?",
    opts: [
      {label: "LS2 does NOT click", next: "nostop_ls2"},
      {label: "LS2 clicks but K1 stays latched", next: "nostop_wiring"},
    ]
  },
  nostop_ls2: {
    answer: "LS2 not being activated.|FIX: Adjust LS2 mounting position. Jog slowly with BWD and verify LS2 triggers at correct home position."
  },
  nostop_wiring: {
    answer: "LS2 may be wired NO instead of NC.|LS2 MUST be NC (closed at rest, opens when cylinder reaches home). If wired to the wrong terminal, K1 will never unlatch.|Check: with switch not actuated, you should have continuity across wired terminals."
  },

  // === FUSE ===
  fuse1: {
    answer: "Repeated blown fuse = short circuit.|Do NOT keep replacing fuse without finding cause.|Disconnect all loads from Bus (A). Reconnect one at a time:|1. FWD jog (W04/W05/W06) â€” check D1|2. BWD jog (W07/W08/W09) â€” check D2|3. K1 circuit â€” check D3|4. K2 circuit â€” check D4|5. K2 outputs (W21/W22/W23)|Most common cause: reversed flyback diode. Backwards diode = dead short across coil."
  },

  // === CHATTER ===
  chatter1: {
    answer: "Relay chatter = insufficient coil voltage.|CHECK: Battery voltage under load (engine running) â€” should be >12V.|Check for voltage drop at relay coil pins â€” should be >10V.|Look for corroded terminals and loose connections on ground circuit (W24, W25).|Clean frame ground bolt (bare metal, star washer)."
  },

  // === HYDRAULIC ===
  hyd1: {
    answer: "Solenoid clicking but no cylinder movement = hydraulic issue, not electrical.|CHECK:|â€¢ Hydraulic fluid level|â€¢ Engine/PTO RPM sufficient|â€¢ Air in hydraulic lines (bleed if needed)|â€¢ Relief valve setting|â€¢ Hydraulic hoses for kinks or damage|The electrical system is working correctly if you hear the solenoid click."
  },
};

const RELAY_PINS = {
  K1: {
    label: "K1 â€” Cycle Latch Relay",
    pins: [
      {pin:1, func:"Pole 1 COM", wire:"W12", conn:"+12V Bus (A)"},
      {pin:2, func:"Coil (+)",   wire:"W15", conn:"From LS2"},
      {pin:3, func:"Pole 1 NC",  wire:"â€”",   conn:"Not used"},
      {pin:4, func:"Pole 1 NO",  wire:"W13", conn:"Junction B (seal)"},
      {pin:5, func:"Pole 2 NO",  wire:"W18", conn:"To LS1"},
      {pin:6, func:"Pole 2 NC",  wire:"â€”",   conn:"Not used (jog interlock)"},
      {pin:7, func:"Coil (âˆ’)",   wire:"W16", conn:"Ground bus"},
      {pin:8, func:"Pole 2 COM", wire:"W17", conn:"+12V Bus (A)"},
    ]
  },
  K2: {
    label: "K2 â€” Direction Relay",
    pins: [
      {pin:1, func:"Pole 1 COM", wire:"W21", conn:"+12V Bus (A)"},
      {pin:2, func:"Coil (+)",   wire:"W19", conn:"From LS1"},
      {pin:3, func:"Pole 1 NC",  wire:"W23", conn:"SOL-B (+)"},
      {pin:4, func:"Pole 1 NO",  wire:"W22", conn:"SOL-A (+)"},
      {pin:5, func:"Pole 2 NO",  wire:"â€”",   conn:"Not used"},
      {pin:6, func:"Pole 2 NC",  wire:"â€”",   conn:"Not used"},
      {pin:7, func:"Coil (âˆ’)",   wire:"W20", conn:"Ground bus"},
      {pin:8, func:"Pole 2 COM", wire:"â€”",   conn:"Not used"},
    ]
  }
};

const INSTALL_PHASES = [
  {
    phase: "Phase 1: Mounting",
    icon: "ðŸ”©",
    steps: [
      {step:"1.1", action:"Mount DIN rail on mounting plate. Secure plate to splitter frame with bolts and lock washers. Choose location protected from rain, hydraulic spray, and heat."},
      {step:"1.2", action:"Mount K1 relay socket on DIN rail (left position)."},
      {step:"1.3", action:"Mount K2 relay socket on DIN rail (right position)."},
      {step:"1.4", action:"Mount DIN-rail terminal blocks between relay sockets. Need at least 3: one for +12V Bus (A), one for Ground bus, one for Junction B."},
      {step:"1.5", action:"Mount inline fuse holder near battery connection point."},
      {step:"1.6", action:"Mount operator panel box on splitter frame â€” accessible from operating position. Drill holes for E-STOP, FWD, BWD, CYCLE. E-STOP should be largest and most prominent."},
      {step:"1.7", action:"Install all pushbuttons in panel box. E-STOP at top, CYCLE below, FWD and BWD at bottom."},
      {step:"1.8", action:"Mount LS1 at full-extend position. Cylinder rod, wedge, or pusher plate should activate it at maximum stroke.",
       test:"Manually push cylinder to full extend. Verify LS1 clicks."},
      {step:"1.9", action:"Mount LS2 at full-retract (home) position. Cylinder rod should activate it when fully retracted.",
       test:"Manually pull cylinder to full retract. Verify LS2 clicks."},
    ]
  },
  {
    phase: "Phase 2: Power Circuit",
    icon: "âš¡",
    steps: [
      {step:"2.1", action:"DISCONNECT BATTERY. Remove negative terminal cable first.", warn:true},
      {step:"2.2", action:"Run W24 (BLACK 12AWG) from battery negative terminal to Ground bus terminal block. Do NOT connect to battery yet."},
      {step:"2.3", action:"Run W25 (BLACK 12AWG) from Ground bus to clean bare metal on splitter frame. Star washer under bolt for good contact."},
      {step:"2.4", action:"Run W01 (RED 12AWG) from battery positive terminal to fuse holder input. Do NOT connect to battery yet."},
      {step:"2.5", action:"Run W02 (RED 12AWG) from fuse holder output to E-STOP NC terminal (C1)."},
      {step:"2.6", action:"Run W03 (RED 12AWG) from E-STOP NC terminal (C2) to +12V Bus (A) terminal block."},
      {step:"2.7", action:"Install 15A fuse in fuse holder."},
      {step:"2.8", action:"Connect battery cables â€” negative first, then positive."},
      {step:"2.9", action:"TEST: Measure voltage at +12V Bus (A) terminal block.",
       test:"EXPECTED: ~12.5V at Bus (A) with E-STOP released.\nPress E-STOP â€” should drop to 0V.\nTwist-release E-STOP â€” voltage returns.\nIf no voltage: check fuse, battery connections, E-STOP wiring."},
    ]
  },
  {
    phase: "Phase 3: Manual Jog",
    icon: "ðŸ•¹ï¸",
    steps: [
      {step:"3.1", action:"Run W04 (RED 14AWG) from +12V Bus (A) to FWD button terminal 1."},
      {step:"3.2", action:"Run W05 (RED 14AWG) from FWD button terminal 2 to SOL-A coil (+)."},
      {step:"3.3", action:"Run W06 (BLACK 14AWG) from SOL-A coil (âˆ’) to Ground bus."},
      {step:"3.4", action:"Install flyback diode D1 (1N4007) across SOL-A coil terminals. CATHODE BAND TOWARD (+) TERMINAL.", warn:true},
      {step:"3.5", action:"TEST: Start hydraulic power unit. Press and hold FWD.",
       test:"EXPECTED: Cylinder extends while FWD held. Release â€” stops.\nIf nothing: check W04, W05, W06. Listen for SOL-A click.\nIf fuse blows: D1 diode is reversed."},
      {step:"3.6", action:"Run W07 (RED 14AWG) from +12V Bus (A) to BWD button terminal 1."},
      {step:"3.7", action:"Run W08 (RED 14AWG) from BWD button terminal 2 to SOL-B coil (+)."},
      {step:"3.8", action:"Run W09 (BLACK 14AWG) from SOL-B coil (âˆ’) to Ground bus."},
      {step:"3.9", action:"Install flyback diode D2 (1N4007) across SOL-B coil terminals. CATHODE BAND TOWARD (+) TERMINAL.", warn:true},
      {step:"3.10", action:"TEST: Press and hold BWD.",
       test:"EXPECTED: Cylinder retracts while BWD held. Release â€” stops.\nSame checks as 3.5 but for SOL-B side."},
      {step:"3.11", action:"TEST: Use FWD and BWD to jog cylinder through full stroke.",
       test:"EXPECTED: LS1 clicks at full extend, LS2 clicks at full retract.\nIf a switch doesn't click: adjust mounting position.\nCritical â€” auto cycle depends on both switches."},
    ]
  },
  {
    phase: "Phase 4: K1 Cycle Latch",
    icon: "ðŸ”„",
    steps: [
      {step:"4.1", action:"Insert K1 relay into DIN rail socket. Note pin orientation â€” pin 1 usually marked on socket."},
      {step:"4.2", action:"Install flyback diode D3 (1N4007) across K1 coil pins 2 and 7. CATHODE BAND TOWARD PIN 2 (+).", warn:true},
      {step:"4.3", action:"Run W10 (RED 14AWG) from +12V Bus (A) to CYCLE button terminal 1."},
      {step:"4.4", action:"Run W11 (RED 16AWG) from CYCLE button terminal 2 to Junction B terminal block."},
      {step:"4.5", action:"Run W12 (RED 16AWG) from +12V Bus (A) to K1 pole 1 common (pin 1)."},
      {step:"4.6", action:"Run W13 (RED 16AWG) from K1 pole 1 NO (pin 4) to Junction B terminal block."},
      {step:"4.7", action:"Run W14 (RED 16AWG) from Junction B to LS2 terminal 1."},
      {step:"4.8", action:"Run W15 (RED 16AWG) from LS2 terminal 2 to K1 coil (+) (pin 2)."},
      {step:"4.9", action:"Run W16 (BLACK 16AWG) from K1 coil (âˆ’) (pin 7) to Ground bus."},
      {step:"4.10", action:"Use BWD to jog cylinder to HOME position. LS2 must be in its normal (closed) state."},
      {step:"4.11", action:"TEST: Press CYCLE momentarily and release.",
       test:"EXPECTED: K1 clicks ON when pressed, STAYS ON after release (seal holding).\nIf K1 drops when you release: check W12 and W13 (seal path). Verify pin 1=COM, pin 4=NO."},
      {step:"4.12", action:"TEST: With K1 latched, jog cylinder away from home with FWD, then back with BWD until LS2 clicks.",
       test:"EXPECTED: When LS2 actuates, K1 UNLATCHES (clicks off).\nConfirms auto-stop at home works.\nIf K1 doesn't drop: check W14, W15 (LS2 path). Verify LS2 is NC type."},
    ]
  },
  {
    phase: "Phase 5: K2 Direction",
    icon: "â†”ï¸",
    steps: [
      {step:"5.1", action:"Insert K2 relay into DIN rail socket."},
      {step:"5.2", action:"Install flyback diode D4 (1N4007) across K2 coil pins 2 and 7. CATHODE BAND TOWARD PIN 2 (+).", warn:true},
      {step:"5.3", action:"Run W17 (RED 14AWG) from +12V Bus (A) to K1 pole 2 common (pin 8)."},
      {step:"5.4", action:"Run W18 (RED 16AWG) from K1 pole 2 NO (pin 5) to LS1 terminal 1."},
      {step:"5.5", action:"Run W19 (RED 16AWG) from LS1 terminal 2 to K2 coil (+) (pin 2)."},
      {step:"5.6", action:"Run W20 (BLACK 16AWG) from K2 coil (âˆ’) (pin 7) to Ground bus."},
      {step:"5.7", action:"TEST: Jog cylinder to HOME with BWD. Press CYCLE to latch K1.",
       test:"EXPECTED: Both K1 AND K2 click ON.\nK2 energizes because K1-2 closes (pin 8â†’5), feeding through LS1 (closed) to K2 coil.\nIf K1 latches but K2 doesn't: check W17, W18, W19, W20."},
    ]
  },
  {
    phase: "Phase 6: K2 Outputs & Full Test",
    icon: "âœ…",
    steps: [
      {step:"6.1", action:"Run W21 (RED 14AWG) from +12V Bus (A) to K2 pole 1 common (pin 1)."},
      {step:"6.2", action:"Run W22 (GREEN 14AWG) from K2 pole 1 NO (pin 4) to SOL-A coil (+)."},
      {step:"6.3", action:"Run W23 (GREEN 14AWG) from K2 pole 1 NC (pin 3) to SOL-B coil (+)."},
      {step:"6.4", action:"NOTE: SOL-A and SOL-B ground wires (W06, W09) already connected from Phase 3. Solenoids now have two power sources each â€” jog buttons and K2."},
      {step:"6.5", action:"Jog cylinder to HOME with BWD. Place a piece of wood on the splitter bed."},
      {step:"6.6", action:"FULL TEST: Press CYCLE once and release.",
       test:"EXPECTED FULL SEQUENCE:\n1. K1 clicks ON (latches)\n2. K2 clicks ON (direction = extend)\n3. SOL-A fires â€” cylinder extends\n4. Cylinder hits wood, splits, continues to LS1\n5. LS1 opens â€” K2 clicks OFF\n6. SOL-B fires â€” cylinder retracts\n7. Cylinder reaches home â€” LS2 opens\n8. K1 clicks OFF â€” cycle complete, all quiet"},
      {step:"6.7", action:"TEST E-STOP: Start another cycle. While extending, press E-STOP.",
       test:"EXPECTED: Everything stops immediately.\nTwist-release E-STOP â€” system dead (K1 unlatched).\nJog home with BWD. New cycle should work normally."},
      {step:"6.8", action:"TEST MANUAL OVERRIDE: During auto cycle, try FWD and BWD buttons.",
       test:"EXPECTED: Jog buttons still work during auto cycle (they bypass relay logic).\nThis is your backup if a relay ever fails."},
    ]
  },
];

function initNav() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });
}

let installChecked = {};

function initInstall() {
  // Load saved progress from memory (not localStorage in PWA artifacts)
  installChecked = {};
  renderInstall();
}

function renderInstall() {
  const el = document.getElementById('install-content');
  const totalSteps = INSTALL_PHASES.reduce((n, p) => n + p.steps.length, 0);
  const doneSteps = Object.keys(installChecked).length;
  const pct = Math.round((doneSteps / totalSteps) * 100);

  let html = `<div class="install-progress">
    <div class="prog-bar-wrap"><div class="prog-bar" style="width:${pct}%"></div></div>
    <div class="prog-text">${doneSteps}/${totalSteps}</div>
  </div>`;

  INSTALL_PHASES.forEach((phase, pi) => {
    const phaseStepIds = phase.steps.map(s => s.step);
    const phaseDone = phaseStepIds.every(id => installChecked[id]);
    const phaseOpen = !phaseDone && (pi === 0 || INSTALL_PHASES[pi-1].steps.every(s => installChecked[s.step]));
    const doneClass = phaseDone ? ' done' : '';
    const openClass = phaseOpen ? ' open' : '';

    html += `<div class="install-phase">
      <div class="phase-header${openClass}${doneClass}" onclick="togglePhase(this)">
        <span class="phase-icon">${phaseDone ? 'âœ…' : phase.icon}</span>
        <span class="phase-title">${phase.phase}</span>
        <span class="phase-count">${phaseStepIds.filter(id => installChecked[id]).length}/${phaseStepIds.length}</span>
        <span class="phase-arrow">â–¶</span>
      </div>
      <div class="phase-steps${phaseOpen ? ' open' : ''}">`;

    phase.steps.forEach(s => {
      const checked = installChecked[s.step];
      const action = highlightWireRefs(s.action);

      html += `<div class="inst-step${checked ? ' completed' : ''}">
        <div class="step-top">
          <div class="step-check${checked ? ' checked' : ''}" onclick="toggleStep('${s.step}')">âœ“</div>
          <div class="step-num">${s.step}</div>
          <div class="step-action">${s.warn ? '<span class="step-warn">âš  </span>' : ''}${action}</div>
        </div>`;

      if (s.test) {
        html += renderTestBlock(s.test);
      }

      html += `</div>`;
    });

    html += `</div></div>`;
  });

  html += `<button class="ts-restart" onclick="resetInstall()" style="margin-top:.5rem">â†© Reset All Progress</button>`;

  el.innerHTML = html;
}

function togglePhase(header) {
  header.classList.toggle('open');
  const steps = header.nextElementSibling;
  steps.classList.toggle('open');
}

function toggleStep(stepId) {
  if (installChecked[stepId]) {
    delete installChecked[stepId];
  } else {
    installChecked[stepId] = true;
  }
  renderInstall();
}

function resetInstall() {
  if (Object.keys(installChecked).length === 0) return;
  installChecked = {};
  renderInstall();
}

function renderTestBlock(raw) {
  const lines = raw.split('\n');
  let html = '<div class="step-test"><div class="test-title">âš  TEST CHECKPOINT</div>';
  lines.forEach(line => {
    line = line.trim();
    if (!line) return;
    if (line.startsWith('EXPECTED')) {
      html += `<div class="test-line expected">${line}</div>`;
    } else if (line.startsWith('If ')) {
      html += `<div class="test-line if-fail">${line}</div>`;
    } else {
      html += `<div class="test-line">${line}</div>`;
    }
  });
  html += '</div>';
  return html;
}

function highlightWireRefs(text) {
  return text.replace(/\b(W\d{2})\b/g, '<span class="wire-ref">$1</span>')
             .replace(/\b(SOL-[AB]|LS[12]|K[12]|D[1-4])\b/g, '<span class="wire-ref">$1</span>');
}

function initWiring() {
  buildWireTable('');
  document.getElementById('wire-search').addEventListener('input', e => buildWireTable(e.target.value));
}

function buildWireTable(filter) {
  const tbody = document.querySelector('#wire-table tbody');
  const f = filter.toLowerCase();
  const rows = WIRES.filter(w =>
    !f || w.id.toLowerCase().includes(f) || w.desc.toLowerCase().includes(f) ||
    w.from.toLowerCase().includes(f) || w.to.toLowerCase().includes(f) ||
    w.color.toLowerCase().includes(f)
  );
  tbody.innerHTML = rows.map(w => {
    const cc = w.color === 'RED' ? 'wire-red' : w.color === 'GRN' ? 'wire-grn' : 'wire-blk';
    const colorName = w.color === 'BLK' ? 'BLACK' : w.color === 'GRN' ? 'GREEN' : 'RED';
    return `<tr>
      <td class="wire-id">${w.id}</td>
      <td class="${cc}">${colorName}</td>
      <td>${w.awg}</td>
      <td>${w.from} â†’ ${w.to}</td>
    </tr>`;
  }).join('');
}

function buildRelayTable(el, relayKey) {
  const r = RELAY_PINS[relayKey];
  el.innerHTML = `<table class="tbl"><thead><tr><th>Pin</th><th>Function</th><th>Wire</th><th>Connection</th></tr></thead><tbody>` +
    r.pins.map(p => {
      const unused = p.wire === 'â€”';
      return `<tr><td class="wire-id">${p.pin}</td><td>${p.func}</td><td>${unused ? '<span class="unused">â€”</span>' : p.wire}</td><td${unused ? ' class="unused"' : ''}>${p.conn}</td></tr>`;
    }).join('') + '</tbody></table>';
}

function initTracer() {
  const sel = document.getElementById('trace-select');
  const wireGroup = document.getElementById('trace-wire-opts');
  WIRES.forEach(w => {
    const opt = document.createElement('option');
    opt.value = 'wire_' + w.id;
    opt.textContent = w.id + ' â€” ' + w.desc;
    wireGroup.appendChild(opt);
  });
  sel.addEventListener('change', () => renderTrace(sel.value));
  renderTrace('power');
}

function renderTrace(key) {
  const el = document.getElementById('trace-result');

  if (key.startsWith('wire_')) {
    renderSingleWire(el, key.replace('wire_', ''));
    return;
  }

  const c = CIRCUITS[key];
  if (!c) { el.innerHTML = ''; return; }

  let html = `<div class="trace-path"><div class="trace-label">${c.label}</div><div class="trace-flow">${pathToHTML(c.path)}</div>`;
  if (c.note) html += `<div class="trace-note">â„¹ ${c.note}</div>`;
  html += '</div>';

  if (c.alt) {
    html += `<div class="trace-path" style="opacity:.85"><div class="trace-label">${c.alt.label}</div><div class="trace-flow">${pathToHTML(c.alt.path)}</div></div>`;
  }
  el.innerHTML = html;
}

function renderSingleWire(el, wireId) {
  const w = WIRES.find(x => x.id === wireId);
  if (!w) { el.innerHTML = ''; return; }
  const cls = w.color === 'RED' ? 'comp-power' : w.color === 'GRN' ? 'comp-solenoid' : 'comp-ground';
  const colorName = w.color === 'BLK' ? 'BLACK' : w.color === 'GRN' ? 'GREEN' : 'RED';
  const circuits = findCircuitsForWire(wireId);
  el.innerHTML = `
    <div class="trace-path">
      <div class="trace-label">${w.id} â€” ${w.desc}</div>
      <div class="trace-flow" style="margin-top:.4rem">
        <span class="trace-component ${cls}">${w.from}</span>
        <span class="trace-arrow">â€”</span>
        <span class="trace-wire">${w.id} Â· ${colorName} ${w.awg}AWG</span>
        <span class="trace-arrow">â†’</span>
        <span class="trace-component ${cls}">${w.to}</span>
      </div>
    </div>
    ${circuits.length ? `<div class="card"><div class="trace-circuits"><strong>Part of:</strong> ${circuits.join(', ')}</div></div>` : ''}`;
}

function pathToHTML(path) {
  return path.map(seg => {
    if (seg.wire) {
      return `<span class="trace-arrow">â†’</span><span class="trace-wire">${seg.wire}</span><span class="trace-arrow">â†’</span>`;
    }
    const cls = 'comp-' + seg.type;
    return `<span class="trace-component ${cls}">${seg.name}</span>`;
  }).join('');
}

let tsHistory = [];

function initTroubleshoot() {
  tsHistory = [];
  renderTsNode('start');
}

function renderTsNode(nodeId) {
  const flow = document.getElementById('ts-flow');
  const node = TS_TREE[nodeId];
  if (!node) return;

  // Update breadcrumb
  if (nodeId === 'start') {
    tsHistory = [{id:'start', label:'Start'}];
  }
  renderBreadcrumb();

  flow.innerHTML = '';

  if (node.answer) {
    flow.innerHTML = renderAnswer(node.answer) + `<button class="ts-restart" onclick="tsRestart()">â†© Start Over</button>`;
    return;
  }

  const div = document.createElement('div');
  div.className = 'ts-node';
  div.innerHTML = `
    <div class="ts-question">${node.q}</div>
    <div class="ts-options">
      ${node.opts.map((o, i) => `<button class="ts-btn" onclick="tsChoose('${o.next}','${escAttr(o.label)}')">${o.label}</button>`).join('')}
    </div>`;
  flow.appendChild(div);
  flow.appendChild(createRestartBtn());
}

function tsChoose(nextId, label) {
  tsHistory.push({id: nextId, label: label});
  renderTsNode(nextId);
  document.querySelector('.content').scrollTop = 0;
}

function tsRestart() {
  tsHistory = [];
  renderTsNode('start');
  document.querySelector('.content').scrollTop = 0;
}

function tsJumpTo(index) {
  tsHistory = tsHistory.slice(0, index + 1);
  renderTsNode(tsHistory[index].id);
}

function renderBreadcrumb() {
  const bc = document.getElementById('ts-breadcrumb');
  if (tsHistory.length <= 1) { bc.innerHTML = ''; return; }
  bc.innerHTML = tsHistory.map((h, i) => {
    const isLast = i === tsHistory.length - 1;
    const text = i === 0 ? 'âŸµ Start' : truncate(h.label, 20);
    return (i > 0 ? '<span class="sep">â€º</span>' : '') +
      (isLast ? `<span style="color:var(--accent)">${text}</span>` : `<span onclick="tsJumpTo(${i})">${text}</span>`);
  }).join('');
}

function renderAnswer(raw) {
  const lines = raw.split('|');
  let html = '<div class="ts-answer">';
  lines.forEach((line, i) => {
    line = line.trim();
    if (i === 0) {
      html += `<strong>${line}</strong>`;
    } else if (line.startsWith('FIX:')) {
      html += `<div class="line"><span class="fix">âœ“ ${line}</span></div>`;
    } else if (line.startsWith('WARNING:') || line.startsWith('Do NOT')) {
      html += `<div class="line"><span class="warn">âš  ${line}</span></div>`;
    } else if (line.startsWith('TRACE:') || line.startsWith('CHECK:')) {
      html += `<div class="trace">${line}</div>`;
    } else {
      html += `<div class="line">${line}</div>`;
    }
  });
  html += '</div>';
  return html;
}

function createRestartBtn() {
  const btn = document.createElement('button');
  btn.className = 'ts-restart';
  btn.textContent = 'â†© Start Over';
  btn.onclick = tsRestart;
  return btn;
}

function truncate(s, n) { return s.length > n ? s.slice(0, n) + 'â€¦' : s; }
function escAttr(s) { return s.replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

let sim = {
  pos: 0,         // 0=home, 100=full extend
  k1: false,
  k2: false,
  solA: false,
  solB: false,
  ls1: false,      // true = actuated (circuit open)
  ls2: true,       // true = actuated (at home, circuit open)
  estop: false,
  jogging: null,   // 'fwd' or 'bwd' or null
  cycling: false,
  phase: 'idle',   // idle, extending, retracting, estop
  animFrame: null,
  lastTime: 0,
};

const SIM_SPEED = 40; // % per second

function initSimulator() {
  simReset();
  simRender();
}

function simReset() {
  sim.pos = 0; sim.k1 = false; sim.k2 = false;
  sim.solA = false; sim.solB = false;
  sim.ls1 = false; sim.ls2 = true;
  sim.estop = false; sim.jogging = null;
  sim.cycling = false; sim.phase = 'idle';
  if (sim.animFrame) cancelAnimationFrame(sim.animFrame);
  sim.animFrame = null;
}

function simJog(dir, pressed) {
  if (sim.estop) return;
  if (pressed) {
    sim.jogging = dir;
    sim.solA = (dir === 'fwd');
    sim.solB = (dir === 'bwd');
    startSimLoop();
  } else {
    if (sim.jogging === dir) {
      sim.jogging = null;
      if (!sim.cycling) {
        sim.solA = false;
        sim.solB = false;
        sim.phase = 'idle';
      }
    }
  }
  simRender();
}

function simCycle() {
  if (sim.estop) return;
  if (sim.cycling) return;
  if (sim.pos > 5) {
    simSetStatus('âš  Jog to HOME first (use BWD)');
    return;
  }
  sim.cycling = true;
  sim.k1 = true;
  sim.k2 = true;
  sim.solA = true;
  sim.solB = false;
  sim.phase = 'extending';
  startSimLoop();
  simRender();
}

function simEstop() {
  sim.estop = true;
  sim.k1 = false; sim.k2 = false;
  sim.solA = false; sim.solB = false;
  sim.cycling = false; sim.jogging = null;
  sim.phase = 'estop';
  simRender();
  // Auto-release after 2s for demo
  setTimeout(() => {
    sim.estop = false;
    sim.phase = 'idle';
    simRender();
  }, 2000);
}

function startSimLoop() {
  if (sim.animFrame) return;
  sim.lastTime = performance.now();
  sim.animFrame = requestAnimationFrame(simTick);
}

function simTick(now) {
  const dt = (now - sim.lastTime) / 1000;
  sim.lastTime = now;

  if (sim.estop) {
    sim.animFrame = null;
    return;
  }

  let moving = false;

  // Jog movement
  if (sim.jogging === 'fwd' && sim.pos < 100) {
    sim.pos = Math.min(100, sim.pos + SIM_SPEED * dt);
    moving = true;
  }
  if (sim.jogging === 'bwd' && sim.pos > 0) {
    sim.pos = Math.max(0, sim.pos - SIM_SPEED * dt);
    moving = true;
  }

  // Cycle movement
  if (sim.cycling) {
    if (sim.phase === 'extending' && sim.solA) {
      sim.pos = Math.min(100, sim.pos + SIM_SPEED * dt);
      moving = true;
    }
    if (sim.phase === 'retracting' && sim.solB) {
      sim.pos = Math.max(0, sim.pos - SIM_SPEED * dt);
      moving = true;
    }
  }

  // Limit switch logic
  sim.ls1 = (sim.pos >= 98);
  sim.ls2 = (sim.pos <= 2);

  // Auto-cycle state transitions
  if (sim.cycling) {
    if (sim.phase === 'extending' && sim.ls1) {
      // LS1 opens â†’ K2 drops â†’ changeover â†’ retract
      sim.k2 = false;
      sim.solA = false;
      sim.solB = true;
      sim.phase = 'retracting';
    }
    if (sim.phase === 'retracting' && sim.ls2) {
      // LS2 opens â†’ K1 drops â†’ cycle complete
      sim.k1 = false; sim.k2 = false;
      sim.solA = false; sim.solB = false;
      sim.cycling = false;
      sim.phase = 'idle';
    }
  }

  // Update jog limit switches
  if (sim.jogging === 'fwd' && sim.pos >= 100) moving = false;
  if (sim.jogging === 'bwd' && sim.pos <= 0) moving = false;

  simRender();

  if (moving || sim.cycling) {
    sim.animFrame = requestAnimationFrame(simTick);
  } else {
    sim.animFrame = null;
  }
}

function simRender() {
  // Buttons
  document.getElementById('sim-fwd').className = 'sim-btn' + (sim.jogging === 'fwd' ? ' active-fwd' : '');
  document.getElementById('sim-bwd').className = 'sim-btn' + (sim.jogging === 'bwd' ? ' active-bwd' : '');
  document.getElementById('sim-cycle').className = 'sim-btn' + (sim.cycling ? ' active-cycle' : '');
  document.getElementById('sim-estop').className = 'sim-btn' + (sim.estop ? ' active-estop' : '');

  // Status
  const statusMap = {
    idle: '<span class="state">IDLE</span> â€” Ready',
    extending: '<span class="state">EXTENDING</span> â€” K1 latched, K2 on, SOL-A firing',
    retracting: '<span class="state">RETRACTING</span> â€” K1 latched, K2 off, SOL-B firing',
    estop: '<span class="state" style="color:var(--red)">E-STOP</span> â€” All power killed',
  };
  let statusText = statusMap[sim.phase] || '';
  if (sim.jogging === 'fwd' && !sim.cycling) statusText = '<span class="state">JOG FWD</span> â€” Manual extend';
  if (sim.jogging === 'bwd' && !sim.cycling) statusText = '<span class="state">JOG BWD</span> â€” Manual retract';
  document.getElementById('sim-status').innerHTML = statusText;

  // Component grid
  setSimItem('si-k1', sim.k1);
  setSimItem('si-k2', sim.k2);
  setSimItem('si-sola', sim.solA);
  setSimItem('si-solb', sim.solB);
  setSimItem('si-ls1', sim.ls1);
  setSimItem('si-ls2', sim.ls2);

  // Cylinder
  const pct = Math.max(10, sim.pos);
  document.getElementById('cyl-rod').style.width = pct + '%';
  document.getElementById('cyl-ls2').className = 'cyl-ls' + (sim.ls2 ? ' active' : '');
  document.getElementById('cyl-ls1').className = 'cyl-ls' + (sim.ls1 ? ' active' : '');
}

function setSimItem(id, on) {
  const el = document.getElementById(id);
  el.className = 'sim-item ' + (on ? 'on' : 'off');
}

function simSetStatus(msg) {
  document.getElementById('sim-status').innerHTML = msg;
}


// Init
document.addEventListener('DOMContentLoaded', () => {
  initNav();
  initInstall();
  initWiring();
  buildRelayTable(document.getElementById('k1-table'), 'K1');
  buildRelayTable(document.getElementById('k2-table'), 'K2');
  initTracer();
  initTroubleshoot();
  initSimulator();

  // Simulator button events (touch + mouse)
  const fwd = document.getElementById('sim-fwd');
  const bwd = document.getElementById('sim-bwd');
  fwd.addEventListener('mousedown', () => simJog('fwd', true));
  fwd.addEventListener('mouseup', () => simJog('fwd', false));
  fwd.addEventListener('mouseleave', () => simJog('fwd', false));
  fwd.addEventListener('touchstart', e => { e.preventDefault(); simJog('fwd', true); });
  fwd.addEventListener('touchend', e => { e.preventDefault(); simJog('fwd', false); });
  bwd.addEventListener('mousedown', () => simJog('bwd', true));
  bwd.addEventListener('mouseup', () => simJog('bwd', false));
  bwd.addEventListener('mouseleave', () => simJog('bwd', false));
  bwd.addEventListener('touchstart', e => { e.preventDefault(); simJog('bwd', true); });
  bwd.addEventListener('touchend', e => { e.preventDefault(); simJog('bwd', false); });
  document.getElementById('sim-cycle').addEventListener('click', simCycle);
  document.getElementById('sim-estop').addEventListener('click', simEstop);
});

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
