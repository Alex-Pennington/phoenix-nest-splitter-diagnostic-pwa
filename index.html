<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0c0f14">
<link rel="manifest" href="manifest.json">
<title>Log Splitter â€” Phoenix Nest</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0c0f14; --bg2:#12161e; --bg3:#1a1f2b; --bg4:#232a38;
  --fg:#e2e6ed; --fg2:#9aa3b4; --fg3:#5e6778;
  --accent:#e8984a; --accent2:#f0b06e;
  --blue:#4a9eed; --green:#4ecb71; --red:#e85454;
  --yellow:#f0d24a; --cyan:#4ec9b0;
  --mono:'JetBrains Mono',monospace; --font:'Outfit',sans-serif;
  --radius:10px; --safe-b:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--bg);color:var(--fg);display:flex;flex-direction:column;touch-action:pan-y}

.header{background:var(--bg2);border-bottom:1px solid var(--bg4);padding:.6rem 1rem;display:flex;align-items:center;gap:.6rem;flex-shrink:0}
.header .logo{font-size:1.4rem}
.header h1{font-family:var(--mono);font-size:.85rem;font-weight:600;color:var(--accent);letter-spacing:.03em}
.header .sub{font-size:.65rem;color:var(--fg3);font-family:var(--mono)}

.tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--bg4);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{flex:1;min-width:0;padding:.6rem .4rem;text-align:center;font-family:var(--mono);font-size:.65rem;font-weight:500;color:var(--fg3);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);background:var(--bg)}
.tab:hover:not(.active){color:var(--fg2)}
.tab-icon{font-size:1.1rem;display:block;margin-bottom:.15rem}

.content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(1rem + var(--safe-b))}
.panel{display:none;padding:1rem}
.panel.active{display:block}

.card{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.8rem;margin-bottom:.6rem}
.card-title{font-family:var(--mono);font-size:.72rem;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem}
.section-title{font-family:var(--mono);font-size:.8rem;font-weight:700;color:var(--fg);margin:1rem 0 .5rem;padding-bottom:.3rem;border-bottom:1px solid var(--bg4)}

.search-box{width:100%;padding:.55rem .7rem;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;color:var(--fg);font-family:var(--mono);font-size:.78rem;margin-bottom:.6rem}
.search-box:focus{border-color:var(--accent);outline:none}
.search-box::placeholder{color:var(--fg3)}

@keyframes fadeSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:4px}

.install-phase{margin-bottom:1rem}
.phase-header{display:flex;align-items:center;gap:.5rem;padding:.6rem .7rem;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;cursor:pointer;user-select:none;-webkit-user-select:none;transition:all .15s}
.phase-header:active{background:var(--bg4)}
.phase-header .phase-icon{font-size:1.2rem}
.phase-header .phase-title{font-family:var(--mono);font-size:.78rem;font-weight:600;color:var(--fg);flex:1}
.phase-header .phase-count{font-family:var(--mono);font-size:.6rem;color:var(--fg3)}
.phase-header .phase-arrow{color:var(--fg3);transition:transform .2s;font-size:.8rem}
.phase-header.open .phase-arrow{transform:rotate(90deg)}
.phase-header.open{border-color:var(--accent);background:var(--bg2)}
.phase-header.done{border-color:var(--green);opacity:.7}
.phase-header.done .phase-title{color:var(--green)}

.phase-steps{display:none;padding:.4rem 0 0}
.phase-steps.open{display:block}

.inst-step{background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;padding:.65rem .7rem;margin-bottom:.35rem;transition:all .15s}
.inst-step.completed{opacity:.5;border-color:var(--green)}
.inst-step.completed .step-action{text-decoration:line-through;text-decoration-color:var(--fg3)}

.step-top{display:flex;align-items:flex-start;gap:.5rem}
.step-check{width:22px;height:22px;border:2px solid var(--bg4);border-radius:5px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;margin-top:.05rem;font-size:.7rem;color:transparent}
.step-check:hover{border-color:var(--accent)}
.step-check.checked{background:var(--green);border-color:var(--green);color:var(--bg)}

.step-num{font-family:var(--mono);font-size:.7rem;font-weight:600;color:var(--accent);min-width:28px;flex-shrink:0;margin-top:.05rem}
.step-action{font-size:.78rem;color:var(--fg);line-height:1.5;flex:1}
.step-action .wire-ref{font-family:var(--mono);font-weight:600;color:var(--cyan);font-size:.74rem}
.step-warn{color:var(--yellow);font-weight:600}

.step-test{background:var(--bg3);border-left:3px solid var(--yellow);border-radius:0 8px 8px 0;padding:.55rem .7rem;margin:.35rem 0 0 30px;font-size:.74rem;line-height:1.6;color:var(--fg2);animation:fadeSlide .2s ease}
.step-test .test-title{font-family:var(--mono);font-size:.65rem;font-weight:600;color:var(--yellow);margin-bottom:.25rem}
.step-test .test-line{margin-bottom:.15rem}
.step-test .expected{color:var(--green);font-weight:500}
.step-test .if-fail{color:var(--red)}

.install-progress{background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;padding:.5rem .7rem;margin-bottom:.8rem;display:flex;align-items:center;gap:.6rem}
.prog-bar-wrap{flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden}
.prog-bar{height:100%;background:var(--green);border-radius:3px;transition:width .3s}
.prog-text{font-family:var(--mono);font-size:.65rem;color:var(--fg3);min-width:42px;text-align:right}

.tbl{width:100%;border-collapse:collapse;font-size:.72rem}
.tbl th{background:var(--bg4);color:var(--accent);font-family:var(--mono);font-weight:600;font-size:.65rem;text-transform:uppercase;letter-spacing:.04em;padding:.5rem .4rem;text-align:left;position:sticky;top:0;z-index:2}
.tbl td{padding:.45rem .4rem;border-bottom:1px solid var(--bg3);color:var(--fg2);vertical-align:top}
.tbl tr:hover td{background:var(--bg3)}
.tbl .wire-id{font-family:var(--mono);font-weight:600;color:var(--fg)}
.tbl .wire-red{color:var(--red);font-weight:600}
.tbl .wire-blk{color:var(--fg);font-weight:600}
.tbl .wire-grn{color:var(--green);font-weight:600}
.tbl .unused{color:var(--fg3);font-style:italic}

.tracer-select{width:100%;padding:.55rem .6rem;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;color:var(--fg);font-family:var(--mono);font-size:.78rem;appearance:none;cursor:pointer;margin-bottom:.8rem}
.tracer-select:focus{border-color:var(--accent);outline:none}
.trace-path{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.7rem;margin-bottom:.5rem}
.trace-label{font-size:.7rem;color:var(--fg3);margin-bottom:.4rem;font-family:var(--mono);font-weight:500}
.trace-flow{display:flex;flex-wrap:wrap;align-items:center;gap:.25rem;line-height:2}
.trace-component{display:inline-block;padding:.2rem .5rem;border-radius:5px;font-family:var(--mono);font-size:.72rem;font-weight:600}
.trace-wire{display:inline-block;padding:.15rem .4rem;border-radius:4px;font-family:var(--mono);font-size:.68rem;font-weight:500;background:var(--bg4);color:var(--fg2)}
.trace-arrow{color:var(--fg3);font-size:.7rem}

.comp-power{background:#3a1a1a;color:var(--red);border:1px solid #5a2a2a}
.comp-switch{background:#1a2a3a;color:var(--blue);border:1px solid #2a3a5a}
.comp-relay{background:#2a2a1a;color:var(--yellow);border:1px solid #4a4a2a}
.comp-solenoid{background:#1a3a1a;color:var(--green);border:1px solid #2a5a2a}
.comp-ground{background:#1a1a1a;color:var(--fg3);border:1px solid #3a3a3a}

.trace-note{font-size:.7rem;color:var(--yellow);margin-top:.4rem;padding:.4rem;background:var(--bg3);border-radius:6px}
.trace-circuits{font-size:.72rem;color:var(--fg3);margin-top:.3rem}
.trace-circuits strong{color:var(--fg2)}

.ts-breadcrumb{font-family:var(--mono);font-size:.6rem;color:var(--fg3);margin-bottom:.6rem;display:flex;flex-wrap:wrap;gap:.2rem}
.ts-breadcrumb span{cursor:pointer}
.ts-breadcrumb span:hover{color:var(--accent)}
.ts-breadcrumb .sep{color:var(--bg4);cursor:default}

.ts-node{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.8rem;margin-bottom:.4rem;animation:fadeSlide .25s ease}
.ts-question{font-size:.82rem;font-weight:500;color:var(--fg);margin-bottom:.6rem;line-height:1.5}
.ts-options{display:flex;flex-direction:column;gap:.35rem}

.ts-btn{display:block;width:100%;padding:.65rem .8rem;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;color:var(--fg);font-family:var(--font);font-size:.78rem;text-align:left;cursor:pointer;transition:all .15s;line-height:1.4}
.ts-btn:hover,.ts-btn:active{background:var(--bg4);border-color:var(--accent)}

.ts-answer{background:var(--bg3);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;padding:.7rem .8rem;margin-bottom:.4rem;font-size:.78rem;line-height:1.6;color:var(--fg2);animation:fadeSlide .25s ease}
.ts-answer strong{color:var(--fg);display:block;margin-bottom:.3rem;font-size:.84rem}
.ts-answer .line{margin-bottom:.3rem}
.ts-answer .fix{color:var(--green);font-weight:500}
.ts-answer .warn{color:var(--yellow);font-weight:500}
.ts-answer .trace{color:var(--cyan);font-family:var(--mono);font-size:.72rem;background:var(--bg4);padding:.3rem .5rem;border-radius:5px;display:block;margin:.3rem 0;word-break:break-all}

.ts-restart{display:block;width:100%;margin-top:.6rem;padding:.6rem;background:none;border:1px dashed var(--fg3);border-radius:8px;color:var(--fg3);font-family:var(--mono);font-size:.7rem;cursor:pointer;text-align:center}
.ts-restart:hover{border-color:var(--accent);color:var(--accent)}

.sim-controls{display:flex;gap:.4rem;margin-bottom:.8rem;flex-wrap:wrap}
.sim-btn{padding:.55rem .8rem;border-radius:8px;border:1px solid var(--bg4);background:var(--bg3);color:var(--fg);font-family:var(--mono);font-size:.72rem;font-weight:500;cursor:pointer;transition:all .15s;flex:1;min-width:70px;text-align:center;user-select:none;-webkit-user-select:none}
.sim-btn:active{transform:scale(.97)}
.sim-btn.active-fwd{background:#2a1a1a;border-color:var(--red);color:var(--red)}
.sim-btn.active-bwd{background:#1a2a1a;border-color:var(--green);color:var(--green)}
.sim-btn.active-cycle{background:#2a2a1a;border-color:var(--yellow);color:var(--yellow)}
.sim-btn.active-estop{background:#3a1a1a;border-color:var(--red);color:var(--red)}

.sim-status{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.6rem;margin-bottom:.5rem;font-family:var(--mono);font-size:.72rem;color:var(--fg2);text-align:center;min-height:2.8rem;display:flex;align-items:center;justify-content:center;line-height:1.4}
.sim-status .state{color:var(--accent);font-weight:600}

.sim-grid{display:grid;grid-template-columns:1fr 1fr;gap:.4rem}
.sim-item{background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;padding:.5rem .6rem;display:flex;align-items:center;gap:.5rem;transition:all .3s}
.sim-item.on{border-color:var(--green);background:#0f1a14}
.sim-item.on .sim-dot{background:var(--green);box-shadow:0 0 8px var(--green)}
.sim-item.off .sim-dot{background:var(--fg3);opacity:.4}
.sim-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;transition:all .3s}
.sim-label{font-family:var(--mono);font-size:.7rem;font-weight:600;color:var(--fg)}
.sim-sublabel{font-size:.6rem;color:var(--fg3);font-weight:400}
.sim-item.on .sim-label{color:var(--green)}

.sim-cylinder{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:.8rem;margin-top:.5rem}
.cyl-title{font-family:var(--mono);font-size:.65rem;color:var(--fg3);margin-bottom:.3rem}
.cyl-track{height:34px;background:var(--bg4);border-radius:6px;position:relative;overflow:hidden;margin:.3rem 0}
.cyl-rod{position:absolute;left:0;top:0;bottom:0;width:10%;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:6px;transition:width .08s linear;min-width:10%}
.cyl-labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.6rem;color:var(--fg3);margin-top:.2rem}
.cyl-ls{font-weight:600;padding:.15rem .35rem;border-radius:4px;transition:all .3s}
.cyl-ls.active{background:var(--green);color:var(--bg)}

</style>
</head>
<body>

<div class="header">
  <span class="logo">âš¡</span>
  <div>
    <h1>LOG SPLITTER</h1>
    <div class="sub">PN-LS-002 Rev C Â· Phoenix Nest LLC</div>
  </div>
</div>

<div class="tabs">
  <button class="tab active" data-tab="install"><span class="tab-icon">ðŸ”¨</span>Install</button>
  <button class="tab" data-tab="troubleshoot"><span class="tab-icon">ðŸ”§</span>Troubleshoot</button>
  <button class="tab" data-tab="wiring"><span class="tab-icon">ðŸ“‹</span>Wiring</button>
  <button class="tab" data-tab="tracer"><span class="tab-icon">âš¡</span>Tracer</button>
  <button class="tab" data-tab="simulator"><span class="tab-icon">â–¶</span>Simulator</button>
</div>

<div class="content">

  <!-- INSTALL -->
  <div class="panel active" id="install">
    <div class="card-title">Installation Guide â€” Rev C (3 Relay)</div>
    <p style="font-size:.75rem;color:var(--fg3);margin-bottom:.6rem">Wire and test one circuit at a time. Check off each step.</p>
    <div id="install-content"></div>
  </div>

  <!-- TROUBLESHOOT -->
  <div class="panel" id="troubleshoot">
    <div class="ts-breadcrumb" id="ts-breadcrumb"></div>
    <div id="ts-flow"></div>
  </div>

  <!-- WIRING -->
  <div class="panel" id="wiring">
    <input class="search-box" id="wire-search" type="text" placeholder="Search wires, relays, components...">
    <div class="section-title">Wire Schedule (W01â€“W30)</div>
    <div style="overflow-x:auto">
      <table class="tbl" id="wire-table">
        <thead><tr><th>ID</th><th>Color</th><th>AWG</th><th>From â†’ To</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="section-title" style="margin-top:1rem">K1 â€” Cycle Latch</div>
    <div id="k1-table" style="overflow-x:auto"></div>
    <div class="section-title" style="margin-top:1rem">K2 â€” Direction</div>
    <div id="k2-table" style="overflow-x:auto"></div>
    <div class="section-title" style="margin-top:1rem">K3 â€” Extend Memory Latch</div>
    <div id="k3-table" style="overflow-x:auto"></div>
    <div class="section-title" style="margin-top:1rem">Flyback Diodes</div>
    <div class="card">
      <div style="font-size:.78rem;color:var(--fg2);line-height:1.7">
        <strong style="color:var(--red)">D1</strong> across SOL-A Â·
        <strong style="color:var(--red)">D2</strong> across SOL-B Â·
        <strong style="color:var(--red)">D3</strong> across K1 coil Â·
        <strong style="color:var(--red)">D4</strong> across K2 coil Â·
        <strong style="color:var(--red)">D5</strong> across K3 coil<br>
        <span style="color:var(--yellow)">âš  Cathode band (stripe) toward (+) on ALL diodes.</span>
      </div>
    </div>
    <div class="section-title" style="margin-top:1rem">Start Procedure</div>
    <div class="card">
      <div style="font-size:.78rem;color:var(--fg2);line-height:1.7">
        <strong style="color:var(--accent)">To start a cycle:</strong> Tap FWD briefly to nudge cylinder off the retract limit, then press CYCLE.<br>
        The retract limit NC pair prevents K1 from latching while the cylinder is at home. This is normal.
      </div>
    </div>
  </div>

  <!-- TRACER -->
  <div class="panel" id="tracer">
    <div class="card-title">Circuit Tracer</div>
    <p style="font-size:.75rem;color:var(--fg3);margin-bottom:.6rem">Select a wire or circuit to trace the full current path.</p>
    <select class="tracer-select" id="trace-select">
      <optgroup label="Circuits">
        <option value="power">Power Bus</option>
        <option value="fwd">Manual FWD Jog</option>
        <option value="bwd">Manual BWD Jog</option>
        <option value="k1">K1 Coil (Cycle Latch)</option>
        <option value="nodex">Node X (K1 Pair 2 NO)</option>
        <option value="k2">K2 Coil (through K3 NC lock)</option>
        <option value="k3">K3 Coil (Extend Memory)</option>
        <option value="k2_extend">K2 â†’ SOL-A (Extend)</option>
        <option value="k2_retract">K2 â†’ SOL-B (Retract)</option>
      </optgroup>
      <optgroup label="Individual Wires" id="trace-wire-opts"></optgroup>
    </select>
    <div id="trace-result"></div>
  </div>

  <!-- SIMULATOR -->
  <div class="panel" id="simulator">
    <div class="card-title">Cycle Simulator â€” Rev C (3 Relay)</div>
    <p style="font-size:.75rem;color:var(--fg3);margin-bottom:.6rem">Tap FWD to nudge off home, then CYCLE. Hold FWD/BWD to jog.</p>
    <div class="sim-controls">
      <button class="sim-btn" id="sim-fwd">â–¶ FWD</button>
      <button class="sim-btn" id="sim-bwd">â—€ BWD</button>
      <button class="sim-btn" id="sim-cycle">âŸ³ CYCLE</button>
      <button class="sim-btn" id="sim-estop">â›” E-STOP</button>
    </div>
    <div class="sim-status" id="sim-status"><span class="state">IDLE</span> â€” Ready</div>
    <div class="sim-grid">
      <div class="sim-item off" id="si-k1"><div class="sim-dot"></div><div><div class="sim-label">K1</div><div class="sim-sublabel">Cycle Latch</div></div></div>
      <div class="sim-item off" id="si-k2"><div class="sim-dot"></div><div><div class="sim-label">K2</div><div class="sim-sublabel">Direction</div></div></div>
      <div class="sim-item off" id="si-k3"><div class="sim-dot"></div><div><div class="sim-label">K3</div><div class="sim-sublabel">Extend Memory</div></div></div>
      <div class="sim-item off" id="si-sola"><div class="sim-dot"></div><div><div class="sim-label">SOL-A</div><div class="sim-sublabel">Extend</div></div></div>
      <div class="sim-item off" id="si-solb"><div class="sim-dot"></div><div><div class="sim-label">SOL-B</div><div class="sim-sublabel">Retract</div></div></div>
      <div class="sim-item off" id="si-extlim"><div class="sim-dot"></div><div><div class="sim-label">EXT LIM</div><div class="sim-sublabel">Extend Limit</div></div></div>
      <div class="sim-item off" id="si-retlim"><div class="sim-dot"></div><div><div class="sim-label">RET LIM</div><div class="sim-sublabel">Retract Limit</div></div></div>
    </div>
    <div class="sim-cylinder">
      <div class="cyl-title">CYLINDER POSITION</div>
      <div class="cyl-track"><div class="cyl-rod" id="cyl-rod"></div></div>
      <div class="cyl-labels">
        <span class="cyl-ls" id="cyl-retlim">RET HOME</span>
        <span>stroke â†’</span>
        <span class="cyl-ls" id="cyl-extlim">EXT LIMIT</span>
      </div>
    </div>
  </div>

</div>

<script>
const WIRES = [
  {id:"W01",desc:"BATT(+) to Fuse",color:"RED",awg:"12",from:"Battery (+)",to:"Fuse input"},
  {id:"W02",desc:"Fuse to E-Stop",color:"RED",awg:"12",from:"Fuse output",to:"E-Stop NC pair"},
  {id:"W03",desc:"E-Stop to Bus A",color:"RED",awg:"12",from:"E-Stop NC pair",to:"+12V Bus (A)"},
  {id:"W04",desc:"Bus A to FWD btn",color:"RED",awg:"14",from:"+12V Bus (A)",to:"FWD NO pair"},
  {id:"W05",desc:"FWD to SOL-A",color:"RED",awg:"14",from:"FWD NO pair",to:"SOL-A (+)"},
  {id:"W06",desc:"SOL-A to GND",color:"BLK",awg:"14",from:"SOL-A (\u2212)",to:"Ground bus"},
  {id:"W07",desc:"Bus A to BWD btn",color:"RED",awg:"14",from:"+12V Bus (A)",to:"BWD NO pair"},
  {id:"W08",desc:"BWD to SOL-B",color:"RED",awg:"14",from:"BWD NO pair",to:"SOL-B (+)"},
  {id:"W09",desc:"SOL-B to GND",color:"BLK",awg:"14",from:"SOL-B (\u2212)",to:"Ground bus"},
  {id:"W10",desc:"Bus A to CYCLE btn",color:"RED",awg:"14",from:"+12V Bus (A)",to:"CYCLE NO pair"},
  {id:"W11",desc:"CYCLE to Jct B",color:"RED",awg:"16",from:"CYCLE NO pair",to:"Junction B"},
  {id:"W12",desc:"Bus A to K1 P1 COM",color:"RED",awg:"16",from:"+12V Bus (A)",to:"K1 Pair 1 COM"},
  {id:"W13",desc:"K1 P1 NO to Jct B",color:"RED",awg:"16",from:"K1 Pair 1 NO",to:"Junction B (seal)"},
  {id:"W14",desc:"Jct B to Retract Lim",color:"RED",awg:"16",from:"Junction B",to:"Retract Limit NC pair"},
  {id:"W15",desc:"Retract Lim to K1 coil",color:"RED",awg:"16",from:"Retract Limit NC pair",to:"K1 Coil (+)"},
  {id:"W16",desc:"K1 coil to GND",color:"BLK",awg:"16",from:"K1 Coil (\u2212)",to:"Ground bus"},
  {id:"W17",desc:"Bus A to K1 P2 COM",color:"RED",awg:"14",from:"+12V Bus (A)",to:"K1 Pair 2 COM"},
  {id:"W18",desc:"K1 P2 NO = Node X",color:"RED",awg:"14",from:"K1 Pair 2 NO",to:"Node X junction"},
  {id:"W19",desc:"Node X to K3 P1 COM",color:"RED",awg:"14",from:"Node X",to:"K3 Pair 1 COM (jumpered to P2 COM)"},
  {id:"W20",desc:"K3 P1 NC to K2 coil",color:"RED",awg:"16",from:"K3 Pair 1 NC",to:"K2 Coil (+)"},
  {id:"W21",desc:"K2 coil to GND",color:"BLK",awg:"16",from:"K2 Coil (\u2212)",to:"Ground bus"},
  {id:"W22",desc:"Node X to Extend Lim",color:"RED",awg:"16",from:"Node X",to:"Extend Limit NO pair"},
  {id:"W23",desc:"Extend Lim to K3 coil",color:"RED",awg:"16",from:"Extend Limit NO pair",to:"K3 Coil (+)"},
  {id:"W24",desc:"K3 P2 NO to K3 coil (seal)",color:"RED",awg:"16",from:"K3 Pair 2 NO",to:"K3 Coil (+)"},
  {id:"W25",desc:"K3 coil to GND",color:"BLK",awg:"16",from:"K3 Coil (\u2212)",to:"Ground bus"},
  {id:"W26",desc:"Node X to K2 P1 COM",color:"RED",awg:"14",from:"Node X",to:"K2 Pair 1 COM"},
  {id:"W27",desc:"K2 P1 NO to SOL-A",color:"GRN",awg:"14",from:"K2 Pair 1 NO",to:"SOL-A (+)"},
  {id:"W28",desc:"K2 P1 NC to SOL-B",color:"GRN",awg:"14",from:"K2 Pair 1 NC",to:"SOL-B (+)"},
  {id:"W29",desc:"BATT(\u2212) to GND bus",color:"BLK",awg:"12",from:"Battery (\u2212)",to:"Ground bus"},
  {id:"W30",desc:"GND bus to Chassis",color:"BLK",awg:"12",from:"Ground bus",to:"Frame bolt"},
];

const CIRCUITS = {
  power: {
    label: "Power Bus",
    path: [
      {type:"power",name:"BATT(+)"},{wire:"W01"},{type:"power",name:"FUSE 15A"},{wire:"W02"},
      {type:"switch",name:"E-STOP NC"},{wire:"W03"},{type:"power",name:"+12V BUS (A)"}
    ]
  },
  fwd: {
    label: "Manual FWD Jog \u2192 SOL-A",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W04"},{type:"switch",name:"FWD btn NO"},{wire:"W05"},
      {type:"solenoid",name:"SOL-A"},{wire:"W06"},{type:"ground",name:"GND"}
    ]
  },
  bwd: {
    label: "Manual BWD Jog \u2192 SOL-B",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W07"},{type:"switch",name:"BWD btn NO"},{wire:"W08"},
      {type:"solenoid",name:"SOL-B"},{wire:"W09"},{type:"ground",name:"GND"}
    ]
  },
  k1: {
    label: "K1 Coil (Cycle Latch)",
    note: "Two parallel paths to Junction B: CYCLE button OR K1 Pair 1 NO seal",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W10"},{type:"switch",name:"CYCLE btn NO"},{wire:"W11"},
      {type:"relay",name:"Jct B"},{wire:"W14"},{type:"switch",name:"Retract Lim NC"},{wire:"W15"},
      {type:"relay",name:"K1 COIL"},{wire:"W16"},{type:"ground",name:"GND"}
    ],
    alt: {
      label: "K1 Seal Path (parallel to CYCLE btn)",
      path: [
        {type:"power",name:"BUS (A)"},{wire:"W12"},{type:"relay",name:"K1 P1 NO"},{wire:"W13"},
        {type:"relay",name:"Jct B"}
      ]
    }
  },
  nodex: {
    label: "Node X (K1 Pair 2 NO \u2014 hot when cycle active)",
    path: [
      {type:"power",name:"BUS (A)"},{wire:"W17"},{type:"relay",name:"K1 P2 NO"},{wire:"W18"},
      {type:"power",name:"NODE X"}
    ]
  },
  k2: {
    label: "K2 Coil (Direction \u2014 through K3 NC lock)",
    note: "K3 Pair 1 NC opens when K3 latches at extend, locking K2 OFF permanently",
    path: [
      {type:"power",name:"NODE X"},{wire:"W19"},{type:"relay",name:"K3 P1 NC"},{wire:"W20"},
      {type:"relay",name:"K2 COIL"},{wire:"W21"},{type:"ground",name:"GND"}
    ]
  },
  k3: {
    label: "K3 Coil (Extend Memory Latch)",
    note: "Triggered by extend limit NO. Seal (K3 P2 NO) holds K3 on after limit releases.",
    path: [
      {type:"power",name:"NODE X"},{wire:"W22"},{type:"switch",name:"Extend Lim NO"},{wire:"W23"},
      {type:"relay",name:"K3 COIL"},{wire:"W25"},{type:"ground",name:"GND"}
    ],
    alt: {
      label: "K3 Seal Path (parallel to Extend Limit)",
      path: [
        {type:"power",name:"NODE X"},{wire:"W24 (via P2 COM)"},{type:"relay",name:"K3 P2 NO"},{wire:"W24"},
        {type:"relay",name:"K3 COIL"}
      ]
    }
  },
  k2_extend: {
    label: "K2 Output \u2192 SOL-A (K2 ON = Extend)",
    path: [
      {type:"power",name:"NODE X"},{wire:"W26"},{type:"relay",name:"K2 P1 NO"},{wire:"W27"},
      {type:"solenoid",name:"SOL-A"},{wire:"W06"},{type:"ground",name:"GND"}
    ]
  },
  k2_retract: {
    label: "K2 Output \u2192 SOL-B (K2 OFF = Retract)",
    path: [
      {type:"power",name:"NODE X"},{wire:"W26"},{type:"relay",name:"K2 P1 NC"},{wire:"W28"},
      {type:"solenoid",name:"SOL-B"},{wire:"W09"},{type:"ground",name:"GND"}
    ]
  }
};

function findCircuitsForWire(wireId) {
  const found = [];
  for (const [k, v] of Object.entries(CIRCUITS)) {
    if (v.path.some(s => s.wire === wireId)) found.push(v.label);
    if (v.alt && v.alt.path.some(s => s.wire === wireId)) found.push(v.alt.label);
  }
  return found;
}

const TS_TREE = {
  start: {
    q: "\ud83d\udd27 What's the problem?",
    opts: [
      {label: "Nothing works \u2014 completely dead", next: "dead1"},
      {label: "FWD jog doesn't work", next: "fwd1"},
      {label: "BWD jog doesn't work", next: "bwd1"},
      {label: "CYCLE button does nothing", next: "cyc1"},
      {label: "Extends but won't auto-retract", next: "noret1"},
      {label: "Retracts but won't stop at home", next: "nostop1"},
      {label: "Cylinder chatters at extend limit", next: "chatter_ext"},
      {label: "Fuse keeps blowing", next: "fuse1"},
      {label: "Relay chatters or buzzes", next: "chatter1"},
      {label: "Solenoid hums, no cylinder movement", next: "hyd1"},
      {label: "Won't start from home position", next: "home_start"},
    ]
  },

  dead1: {
    q: "\u26a1 Measure battery voltage.",
    opts: [
      {label: "Less than 11V", next: "dead_batt"},
      {label: "12V+ at battery", next: "dead2"},
    ]
  },
  dead_batt: { answer: "Battery is dead or weak.|FIX: Charge or replace battery." },
  dead2: {
    q: "Check the fuse. Is it blown?",
    opts: [
      {label: "Fuse is blown", next: "dead_fuse"},
      {label: "Fuse is good", next: "dead3"},
    ]
  },
  dead_fuse: { answer: "Blown fuse = short circuit.|Do NOT just replace. Disconnect loads one at a time to find the short.|CHECK: flyback diode orientation on all five coils (D1\u2013D5). Reversed = dead short." },
  dead3: {
    q: "Is E-Stop pressed in?",
    opts: [
      {label: "Yes", next: "dead_estop"},
      {label: "No \u2014 released", next: "dead4"},
    ]
  },
  dead_estop: { answer: "FIX: Twist E-Stop to release. Power should return to Bus (A)." },
  dead4: {
    q: "Measure voltage at +12V Bus (A).",
    opts: [
      {label: "0V at Bus A", next: "dead_bus"},
      {label: "~12V at Bus A", next: "dead_busok"},
    ]
  },
  dead_bus: { answer: "Power not reaching Bus A.|TRACE: BATT(+) \u2192 W01 \u2192 FUSE \u2192 W02 \u2192 E-STOP NC \u2192 W03 \u2192 Bus A|Check each connection for continuity." },
  dead_busok: { answer: "Bus A has power \u2014 problem is downstream.|Go back and pick a more specific symptom." },

  fwd1: {
    q: "Hold FWD. Measure voltage at FWD button output.",
    opts: [
      {label: "0V at output", next: "fwd_nop"},
      {label: "~12V at output", next: "fwd2"},
    ]
  },
  fwd_nop: { answer: "No power through FWD.|CHECK: W04 from Bus A to FWD. Verify button works. Measure both sides." },
  fwd2: {
    q: "Does SOL-A click when FWD is pressed?",
    opts: [
      {label: "No click", next: "fwd_nosol"},
      {label: "Clicks but no movement", next: "hyd1"},
    ]
  },
  fwd_nosol: { answer: "Power not reaching SOL-A.|CHECK: W05 (FWD to SOL-A+) and W06 (SOL-A\u2212 to GND).|WARNING: If D1 reversed = dead short = blown fuse." },

  bwd1: { answer: "Same diagnostic as FWD but for retract circuit.|CHECK: W07, W08, W09, and D2 orientation." },

  cyc1: {
    q: "Is cylinder sitting on the retract limit?",
    opts: [
      {label: "Yes \u2014 fully retracted at home", next: "home_start"},
      {label: "No \u2014 cylinder is mid-stroke or extended", next: "cyc2"},
    ]
  },
  cyc2: {
    q: "Press CYCLE. Does K1 click?",
    opts: [
      {label: "K1 does NOT click", next: "cyc_nok1"},
      {label: "K1 clicks", next: "cyc3"},
    ]
  },
  cyc_nok1: { answer: "K1 not energizing.|TRACE while holding CYCLE: Bus A \u2192 W10 \u2192 CYCLE btn \u2192 W11 \u2192 Jct B \u2192 W14 \u2192 Retract Lim NC \u2192 W15 \u2192 K1 Coil|Find where voltage drops to 0." },
  cyc3: {
    q: "Release CYCLE. Does K1 stay latched?",
    opts: [
      {label: "K1 drops when released", next: "cyc_noseal"},
      {label: "K1 stays on", next: "cyc4"},
    ]
  },
  cyc_noseal: { answer: "Seal not working.|CHECK: W12 (Bus A \u2192 K1 Pair 1 COM) and W13 (K1 Pair 1 NO \u2192 Junction B)." },
  cyc4: {
    q: "Does K2 come on when K1 latches?",
    opts: [
      {label: "K2 does NOT come on", next: "cyc_nok2"},
      {label: "K2 comes on", next: "cyc5"},
    ]
  },
  cyc_nok2: { answer: "K2 coil not getting power.|CHECK: Node X has voltage (K1 Pair 2 NO output).|CHECK: K3 is OFF and K3 Pair 1 NC is closed.|TRACE: Node X \u2192 W19 \u2192 K3 P1 COM \u2192 K3 P1 NC \u2192 W20 \u2192 K2 Coil" },
  cyc5: {
    q: "Does the cylinder extend?",
    opts: [
      {label: "No movement", next: "cyc_nomove"},
      {label: "Yes \u2014 extends", next: "cyc_ok"},
    ]
  },
  cyc_nomove: { answer: "K2 on but SOL-A not firing.|CHECK: W26 (Node X \u2192 K2 P1 COM) and W27 (K2 P1 NO \u2192 SOL-A+).|Verify K2 changeover is switching to NO when energized." },
  cyc_ok: { answer: "Cycle starting correctly! If retract has issues, go back and pick that symptom." },

  noret1: {
    q: "At full extend, does K3 pick up?",
    opts: [
      {label: "K3 does NOT pick up", next: "noret_nok3"},
      {label: "K3 picks up but K2 stays on", next: "noret_k2stays"},
      {label: "K3 picks up, K2 drops, but no retract", next: "noret_nosolb"},
    ]
  },
  noret_nok3: { answer: "Extend limit not triggering K3.|CHECK: Extend limit NO pair \u2014 does it close when cylinder is at full extend?|CHECK: W22 (Node X \u2192 Extend Lim) and W23 (Extend Lim \u2192 K3 Coil+).|CHECK: W25 (K3 Coil\u2212 \u2192 GND)." },
  noret_k2stays: { answer: "K3 NC contact not breaking K2 coil circuit.|CHECK: W19 (Node X \u2192 K3 P1 COM) and W20 (K3 P1 NC \u2192 K2 Coil+).|Verify K3 P1 NC actually opens when K3 energizes. Test with multimeter." },
  noret_nosolb: { answer: "K2 dropped but SOL-B not firing.|CHECK: W28 (K2 P1 NC \u2192 SOL-B+). When K2 is off, P1 COM connects to P1 NC.|CHECK: SOL-B ground W09." },

  nostop1: {
    q: "At home, does K1 drop?",
    opts: [
      {label: "K1 does NOT drop", next: "nostop_k1"},
      {label: "K1 drops but cylinder keeps moving", next: "nostop_still"},
    ]
  },
  nostop_k1: { answer: "Retract limit not breaking K1.|CHECK: Retract limit NC pair \u2014 does it open when cylinder reaches home?|Adjust switch mounting position if needed." },
  nostop_still: { answer: "K1 dropped but solenoid still firing.|If K1 dropped, Node X should be dead, killing all relay outputs.|CHECK: Is BWD button stuck or held? BWD bypasses relays and feeds SOL-B directly." },

  chatter_ext: { answer: "K2 bouncing at extend limit = K3 not latching properly.|CHECK: K3 seal \u2014 W24 (K3 P2 NO \u2192 K3 Coil+). This holds K3 on after extend limit releases.|CHECK: K3 P2 COM is jumpered to K3 P1 COM (both fed from Node X).|If seal wire is missing, K3 drops when cylinder moves off extend limit, K2 comes back, and it bounces." },

  fuse1: { answer: "Repeated blown fuse = short circuit.|Disconnect all loads from Bus A. Reconnect one at a time.|CHECK: flyback diodes D1\u2013D5. Reversed diode = dead short across coil when energized.|Most common cause by far." },

  chatter1: { answer: "Relay chatter = low coil voltage.|CHECK: Battery voltage under load (>12V).|CHECK: Ground connections \u2014 W29 (BATT\u2212 to GND bus), W30 (GND bus to frame).|Clean frame ground bolt, use star washer." },

  hyd1: { answer: "Solenoid clicking but no movement = hydraulic issue.|CHECK: Fluid level, engine/PTO RPM, air in lines, relief valve, hose condition.|Electrical system is working if you hear the click." },

  home_start: { answer: "Normal behavior. Retract limit NC pair is open when cylinder is at home, which prevents K1 from latching.|FIX: Tap FWD briefly to nudge cylinder off the retract limit, then press CYCLE. This is the designed start procedure \u2014 FWD then CYCLE." },
};

const RELAY_PINS = {
  K1: {
    label: "K1 \u2014 Cycle Latch Relay",
    pins: [
      {pin:"Coil (+)", wire:"W15", conn:"From Retract Limit NC pair"},
      {pin:"Coil (\u2212)", wire:"W16", conn:"Ground bus"},
      {pin:"Pair 1 COM", wire:"W12", conn:"+12V Bus (A)"},
      {pin:"Pair 1 NO", wire:"W13", conn:"Junction B (seal)"},
      {pin:"Pair 1 NC", wire:"\u2014", conn:"Not used"},
      {pin:"Pair 2 COM", wire:"W17", conn:"+12V Bus (A)"},
      {pin:"Pair 2 NO", wire:"W18", conn:"Node X (feeds K2 output, K2 coil via K3, K3 coil via extend lim)"},
      {pin:"Pair 2 NC", wire:"\u2014", conn:"Not used"},
    ]
  },
  K2: {
    label: "K2 \u2014 Direction Relay",
    pins: [
      {pin:"Coil (+)", wire:"W20", conn:"From K3 Pair 1 NC (locked off when K3 latches)"},
      {pin:"Coil (\u2212)", wire:"W21", conn:"Ground bus"},
      {pin:"Pair 1 COM", wire:"W26", conn:"Node X (solenoid output power)"},
      {pin:"Pair 1 NO", wire:"W27", conn:"SOL-A (+) \u2014 EXTEND"},
      {pin:"Pair 1 NC", wire:"W28", conn:"SOL-B (+) \u2014 RETRACT"},
      {pin:"Pair 2 COM", wire:"\u2014", conn:"Not used"},
      {pin:"Pair 2 NO", wire:"\u2014", conn:"Not used"},
      {pin:"Pair 2 NC", wire:"\u2014", conn:"Not used"},
    ]
  },
  K3: {
    label: "K3 \u2014 Extend Memory Latch",
    pins: [
      {pin:"Coil (+)", wire:"W23 + W24", conn:"From Extend Limit NO pair AND K3 Pair 2 NO (seal) \u2014 two wires on same terminal"},
      {pin:"Coil (\u2212)", wire:"W25", conn:"Ground bus"},
      {pin:"Pair 1 COM", wire:"W19", conn:"Node X (jumpered to Pair 2 COM)"},
      {pin:"Pair 1 NO", wire:"\u2014", conn:"Not used"},
      {pin:"Pair 1 NC", wire:"W20", conn:"K2 Coil (+) \u2014 THE LOCK"},
      {pin:"Pair 2 COM", wire:"jumper", conn:"Jumpered to Pair 1 COM"},
      {pin:"Pair 2 NO", wire:"W24", conn:"K3 Coil (+) \u2014 THE SEAL"},
      {pin:"Pair 2 NC", wire:"\u2014", conn:"Not used"},
    ]
  }
};

const INSTALL_PHASES = [
  {
    phase: "Phase 1: Mounting",
    icon: "\ud83d\udd29",
    steps: [
      {step:"1.1", action:"Mount DIN rail on mounting plate. Secure to splitter frame. Protected from rain, hydraulic spray, heat."},
      {step:"1.2", action:"Mount K1, K2, K3 relay sockets on DIN rail. K1 left, K2 center, K3 right."},
      {step:"1.3", action:"Mount DIN-rail terminal blocks. Need: +12V Bus (A), Ground bus, Junction B, Node X."},
      {step:"1.4", action:"Mount inline fuse holder near battery."},
      {step:"1.5", action:"Mount operator panel box. Drill for E-STOP, FWD, BWD, CYCLE. E-STOP largest, top position."},
      {step:"1.6", action:"Install pushbuttons. E-STOP top, CYCLE below, FWD and BWD bottom."},
      {step:"1.7", action:"Mount extend limit switch at full-extend position.",
       test:"Push cylinder to full extend. Verify NO pair closes (continuity test)."},
      {step:"1.8", action:"Mount retract limit switch at full-retract (home) position.",
       test:"Pull cylinder to full retract. Verify NC pair opens (continuity breaks)."},
    ]
  },
  {
    phase: "Phase 2: Power Circuit",
    icon: "\u26a1",
    steps: [
      {step:"2.1", action:"DISCONNECT BATTERY. Negative terminal first.", warn:true},
      {step:"2.2", action:"W29: BLACK 12AWG \u2014 Battery (\u2212) to Ground bus."},
      {step:"2.3", action:"W30: BLACK 12AWG \u2014 Ground bus to frame bolt (clean metal, star washer)."},
      {step:"2.4", action:"W01: RED 12AWG \u2014 Battery (+) to fuse holder input."},
      {step:"2.5", action:"W02: RED 12AWG \u2014 Fuse output to E-STOP NC pair."},
      {step:"2.6", action:"W03: RED 12AWG \u2014 E-STOP NC pair to +12V Bus (A)."},
      {step:"2.7", action:"Install 15A fuse. Reconnect battery (negative first, then positive)."},
      {step:"2.8", action:"TEST: Measure voltage at Bus (A).",
       test:"EXPECTED: ~12.5V with E-STOP released.\nPress E-STOP \u2014 drops to 0V.\nRelease \u2014 voltage returns."},
    ]
  },
  {
    phase: "Phase 3: Manual Jog",
    icon: "\ud83d\udd79\ufe0f",
    steps: [
      {step:"3.1", action:"W04: RED 14AWG \u2014 Bus (A) to FWD NO pair."},
      {step:"3.2", action:"W05: RED 14AWG \u2014 FWD NO pair to SOL-A (+)."},
      {step:"3.3", action:"W06: BLACK 14AWG \u2014 SOL-A (\u2212) to Ground bus."},
      {step:"3.4", action:"Diode D1 across SOL-A. Cathode stripe toward (+).", warn:true},
      {step:"3.5", action:"TEST: Start hydraulics. Hold FWD.",
       test:"EXPECTED: Cylinder extends while held. Stops on release."},
      {step:"3.6", action:"W07: RED 14AWG \u2014 Bus (A) to BWD NO pair."},
      {step:"3.7", action:"W08: RED 14AWG \u2014 BWD NO pair to SOL-B (+)."},
      {step:"3.8", action:"W09: BLACK 14AWG \u2014 SOL-B (\u2212) to Ground bus."},
      {step:"3.9", action:"Diode D2 across SOL-B. Cathode stripe toward (+).", warn:true},
      {step:"3.10", action:"TEST: Hold BWD.",
       test:"EXPECTED: Cylinder retracts while held. Stops on release."},
      {step:"3.11", action:"TEST: Jog full stroke both ways.",
       test:"EXPECTED: Extend limit NO pair closes at full extend.\nRetract limit NC pair opens at full retract."},
    ]
  },
  {
    phase: "Phase 4: K1 Cycle Latch",
    icon: "\ud83d\udd04",
    steps: [
      {step:"4.1", action:"Insert K1 relay. Diode D3 across coil. Cathode toward (+).", warn:true},
      {step:"4.2", action:"W10: RED 14AWG \u2014 Bus (A) to CYCLE NO pair."},
      {step:"4.3", action:"W11: RED 16AWG \u2014 CYCLE NO pair to Junction B."},
      {step:"4.4", action:"W12: RED 16AWG \u2014 Bus (A) to K1 Pair 1 COM."},
      {step:"4.5", action:"W13: RED 16AWG \u2014 K1 Pair 1 NO to Junction B."},
      {step:"4.6", action:"W14: RED 16AWG \u2014 Junction B to Retract Limit NC pair."},
      {step:"4.7", action:"W15: RED 16AWG \u2014 Retract Limit NC pair to K1 Coil (+)."},
      {step:"4.8", action:"W16: BLACK 16AWG \u2014 K1 Coil (\u2212) to Ground bus."},
      {step:"4.9", action:"Jog cylinder off the retract limit with FWD."},
      {step:"4.10", action:"TEST: Press CYCLE and release.",
       test:"EXPECTED: K1 picks up and STAYS latched after release.\nIf it drops: check W12 and W13 (seal path)."},
      {step:"4.11", action:"TEST: Jog cylinder to home with BWD until retract limit trips.",
       test:"EXPECTED: K1 drops when retract limit opens.\nConfirms cycle-end works."},
    ]
  },
  {
    phase: "Phase 5: Node X + K3 Extend Memory",
    icon: "\ud83e\udde0",
    steps: [
      {step:"5.1", action:"W17: RED 14AWG \u2014 Bus (A) to K1 Pair 2 COM."},
      {step:"5.2", action:"W18: RED 14AWG \u2014 K1 Pair 2 NO to Node X terminal block."},
      {step:"5.3", action:"Insert K3 relay. Diode D5 across coil. Cathode toward (+).", warn:true},
      {step:"5.4", action:"W19: RED 14AWG \u2014 Node X to K3 Pair 1 COM. Jumper K3 Pair 1 COM to K3 Pair 2 COM."},
      {step:"5.5", action:"W22: RED 16AWG \u2014 Node X to Extend Limit NO pair."},
      {step:"5.6", action:"W23: RED 16AWG \u2014 Extend Limit NO pair to K3 Coil (+)."},
      {step:"5.7", action:"W24: RED 16AWG \u2014 K3 Pair 2 NO to K3 Coil (+). This is the seal \u2014 lands on same terminal as W23."},
      {step:"5.8", action:"W25: BLACK 16AWG \u2014 K3 Coil (\u2212) to Ground bus."},
      {step:"5.9", action:"TEST: Jog off home. Press CYCLE (K1 latches). Trigger extend limit.",
       test:"EXPECTED: K3 picks up when extend limit closes.\nRelease extend limit \u2014 K3 STAYS latched (seal holding)."},
    ]
  },
  {
    phase: "Phase 6: K2 Direction + Outputs",
    icon: "\u2705",
    steps: [
      {step:"6.1", action:"Insert K2 relay. Diode D4 across coil. Cathode toward (+).", warn:true},
      {step:"6.2", action:"W20: RED 16AWG \u2014 K3 Pair 1 NC to K2 Coil (+). This is the lock."},
      {step:"6.3", action:"W21: BLACK 16AWG \u2014 K2 Coil (\u2212) to Ground bus."},
      {step:"6.4", action:"W26: RED 14AWG \u2014 Node X to K2 Pair 1 COM."},
      {step:"6.5", action:"W27: GREEN 14AWG \u2014 K2 Pair 1 NO to SOL-A (+)."},
      {step:"6.6", action:"W28: GREEN 14AWG \u2014 K2 Pair 1 NC to SOL-B (+)."},
      {step:"6.7", action:"TEST: Jog off home. Press CYCLE.",
       test:"EXPECTED: K1 latches, K2 picks up. SOL-A fires \u2014 cylinder extends."},
      {step:"6.8", action:"TEST: Let cylinder hit extend limit.",
       test:"EXPECTED: K3 picks up, K2 drops. SOL-B fires \u2014 cylinder retracts.\nK2 stays off (no bounce)."},
      {step:"6.9", action:"TEST: Let cylinder hit retract limit.",
       test:"EXPECTED: K1 drops. Everything shuts off. Cycle complete."},
      {step:"6.10", action:"TEST E-STOP: Start a cycle. Press E-STOP mid-extend.",
       test:"EXPECTED: Everything stops immediately.\nRelease E-STOP. Jog home with BWD. New cycle works."},
      {step:"6.11", action:"START PROCEDURE: Tap FWD to nudge off home, then press CYCLE.",
       test:"This is normal. Retract limit prevents K1 from latching at home.\nFWD nudge moves cylinder off limit, then CYCLE starts auto sequence."},
    ]
  },
];

function initNav() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });
}

let installChecked = {};

function initInstall() { installChecked = {}; renderInstall(); }

function renderInstall() {
  const el = document.getElementById('install-content');
  const totalSteps = INSTALL_PHASES.reduce((n,p) => n+p.steps.length, 0);
  const doneSteps = Object.keys(installChecked).length;
  const pct = Math.round((doneSteps/totalSteps)*100);

  let html = `<div class="install-progress"><div class="prog-bar-wrap"><div class="prog-bar" style="width:${pct}%"></div></div><div class="prog-text">${doneSteps}/${totalSteps}</div></div>`;

  INSTALL_PHASES.forEach((phase,pi) => {
    const ids=phase.steps.map(s=>s.step);
    const phaseDone=ids.every(id=>installChecked[id]);
    const phaseOpen=!phaseDone&&(pi===0||INSTALL_PHASES[pi-1].steps.every(s=>installChecked[s.step]));
    html += `<div class="install-phase"><div class="phase-header${phaseOpen?' open':''}${phaseDone?' done':''}" onclick="togglePhase(this)"><span class="phase-icon">${phaseDone?'\u2705':phase.icon}</span><span class="phase-title">${phase.phase}</span><span class="phase-count">${ids.filter(id=>installChecked[id]).length}/${ids.length}</span><span class="phase-arrow">\u25b6</span></div><div class="phase-steps${phaseOpen?' open':''}">`;
    phase.steps.forEach(s => {
      const checked=installChecked[s.step];
      const action=highlightWireRefs(s.action);
      html += `<div class="inst-step${checked?' completed':''}"><div class="step-top"><div class="step-check${checked?' checked':''}" onclick="toggleStep('${s.step}')">\u2713</div><div class="step-num">${s.step}</div><div class="step-action">${s.warn?'<span class="step-warn">\u26a0 </span>':''}${action}</div></div>`;
      if(s.test) html += renderTestBlock(s.test);
      html += '</div>';
    });
    html += '</div></div>';
  });
  html += `<button class="ts-restart" onclick="resetInstall()" style="margin-top:.5rem">\u21a9 Reset All Progress</button>`;
  el.innerHTML = html;
}

function togglePhase(h){ h.classList.toggle('open'); h.nextElementSibling.classList.toggle('open'); }
function toggleStep(id){ if(installChecked[id]) delete installChecked[id]; else installChecked[id]=true; renderInstall(); }
function resetInstall(){ if(!Object.keys(installChecked).length) return; installChecked={}; renderInstall(); }

function renderTestBlock(raw) {
  const lines=raw.split('\n');
  let html='<div class="step-test"><div class="test-title">\u26a0 TEST CHECKPOINT</div>';
  lines.forEach(line => { line=line.trim(); if(!line) return;
    if(line.startsWith('EXPECTED')) html+=`<div class="test-line expected">${line}</div>`;
    else if(line.startsWith('If')) html+=`<div class="test-line if-fail">${line}</div>`;
    else html+=`<div class="test-line">${line}</div>`;
  });
  return html+'</div>';
}

function highlightWireRefs(text) {
  return text.replace(/\b(W\d{2})\b/g,'<span class="wire-ref">$1</span>')
    .replace(/\b(SOL-[AB]|K[123]|D[1-5])\b/g,'<span class="wire-ref">$1</span>');
}

function initWiring() {
  buildWireTable('');
  document.getElementById('wire-search').addEventListener('input', e => buildWireTable(e.target.value));
}

function buildWireTable(filter) {
  const tbody = document.querySelector('#wire-table tbody');
  const f = filter.toLowerCase();
  const rows = WIRES.filter(w =>
    !f || w.id.toLowerCase().includes(f) || w.desc.toLowerCase().includes(f) ||
    w.from.toLowerCase().includes(f) || w.to.toLowerCase().includes(f) ||
    w.color.toLowerCase().includes(f)
  );
  tbody.innerHTML = rows.map(w => {
    const cc = w.color === 'RED' ? 'wire-red' : w.color === 'GRN' ? 'wire-grn' : 'wire-blk';
    const colorName = w.color === 'BLK' ? 'BLACK' : w.color === 'GRN' ? 'GREEN' : 'RED';
    return `<tr><td class="wire-id">${w.id}</td><td class="${cc}">${colorName}</td><td>${w.awg}</td><td>${w.from} \u2192 ${w.to}</td></tr>`;
  }).join('');
}

function buildRelayTable(el, relayKey) {
  const r = RELAY_PINS[relayKey];
  el.innerHTML = `<table class="tbl"><thead><tr><th>Terminal</th><th>Wire</th><th>Connection</th></tr></thead><tbody>` +
    r.pins.map(p => {
      const unused = p.wire === '\u2014';
      return `<tr><td class="wire-id">${p.pin}</td><td>${unused ? '<span class="unused">\u2014</span>' : p.wire}</td><td${unused ? ' class="unused"' : ''}>${p.conn}</td></tr>`;
    }).join('') + '</tbody></table>';
}

function initTracer() {
  const sel = document.getElementById('trace-select');
  const wireGroup = document.getElementById('trace-wire-opts');
  WIRES.forEach(w => {
    const opt = document.createElement('option');
    opt.value = 'wire_' + w.id;
    opt.textContent = w.id + ' \u2014 ' + w.desc;
    wireGroup.appendChild(opt);
  });
  sel.addEventListener('change', () => renderTrace(sel.value));
  renderTrace('power');
}

function renderTrace(key) {
  const el = document.getElementById('trace-result');
  if (key.startsWith('wire_')) { renderSingleWire(el, key.replace('wire_','')); return; }
  const c = CIRCUITS[key];
  if (!c) { el.innerHTML = ''; return; }
  let html = `<div class="trace-path"><div class="trace-label">${c.label}</div><div class="trace-flow">${pathToHTML(c.path)}</div>`;
  if (c.note) html += `<div class="trace-note">\u2139 ${c.note}</div>`;
  html += '</div>';
  if (c.alt) html += `<div class="trace-path" style="opacity:.85"><div class="trace-label">${c.alt.label}</div><div class="trace-flow">${pathToHTML(c.alt.path)}</div></div>`;
  el.innerHTML = html;
}

function renderSingleWire(el, wireId) {
  const w = WIRES.find(x => x.id === wireId);
  if (!w) { el.innerHTML = ''; return; }
  const cls = w.color === 'RED' ? 'comp-power' : w.color === 'GRN' ? 'comp-solenoid' : 'comp-ground';
  const colorName = w.color === 'BLK' ? 'BLACK' : w.color === 'GRN' ? 'GREEN' : 'RED';
  const circuits = findCircuitsForWire(wireId);
  el.innerHTML = `<div class="trace-path"><div class="trace-label">${w.id} \u2014 ${w.desc}</div><div class="trace-flow" style="margin-top:.4rem"><span class="trace-component ${cls}">${w.from}</span><span class="trace-arrow">\u2014</span><span class="trace-wire">${w.id} \u00b7 ${colorName} ${w.awg}AWG</span><span class="trace-arrow">\u2192</span><span class="trace-component ${cls}">${w.to}</span></div></div>${circuits.length?`<div class="card"><div class="trace-circuits"><strong>Part of:</strong> ${circuits.join(', ')}</div></div>`:''}`;
}

function pathToHTML(path) {
  return path.map(seg => {
    if (seg.wire) return `<span class="trace-arrow">\u2192</span><span class="trace-wire">${seg.wire}</span><span class="trace-arrow">\u2192</span>`;
    return `<span class="trace-component comp-${seg.type}">${seg.name}</span>`;
  }).join('');
}

let tsHistory = [];

function initTroubleshoot() { tsHistory = []; renderTsNode('start'); }

function renderTsNode(nodeId) {
  const flow = document.getElementById('ts-flow');
  const node = TS_TREE[nodeId];
  if (!node) return;
  if (nodeId === 'start') tsHistory = [{id:'start', label:'Start'}];
  renderBreadcrumb();
  flow.innerHTML = '';
  if (node.answer) {
    flow.innerHTML = renderAnswer(node.answer) + `<button class="ts-restart" onclick="tsRestart()">\u21a9 Start Over</button>`;
    return;
  }
  const div = document.createElement('div');
  div.className = 'ts-node';
  div.innerHTML = `<div class="ts-question">${node.q}</div><div class="ts-options">${node.opts.map(o => `<button class="ts-btn" onclick="tsChoose('${o.next}','${escAttr(o.label)}')">${o.label}</button>`).join('')}</div>`;
  flow.appendChild(div);
  flow.appendChild(createRestartBtn());
}

function tsChoose(nextId, label) {
  tsHistory.push({id:nextId, label:label});
  renderTsNode(nextId);
  document.querySelector('.content').scrollTop = 0;
}

function tsRestart() { tsHistory=[]; renderTsNode('start'); document.querySelector('.content').scrollTop=0; }

function tsJumpTo(index) { tsHistory=tsHistory.slice(0,index+1); renderTsNode(tsHistory[index].id); }

function renderBreadcrumb() {
  const bc = document.getElementById('ts-breadcrumb');
  if (tsHistory.length<=1) { bc.innerHTML=''; return; }
  bc.innerHTML = tsHistory.map((h,i) => {
    const isLast = i===tsHistory.length-1;
    const text = i===0 ? '\u27f5 Start' : truncate(h.label,20);
    return (i>0?'<span class="sep">\u203a</span>':'') +
      (isLast?`<span style="color:var(--accent)">${text}</span>`:`<span onclick="tsJumpTo(${i})">${text}</span>`);
  }).join('');
}

function renderAnswer(raw) {
  const lines = raw.split('|');
  let html = '<div class="ts-answer">';
  lines.forEach((line,i) => {
    line = line.trim();
    if (i===0) html += `<strong>${line}</strong>`;
    else if (line.startsWith('FIX:')) html += `<div class="line"><span class="fix">\u2713 ${line}</span></div>`;
    else if (line.startsWith('WARNING:')||line.startsWith('Do NOT')) html += `<div class="line"><span class="warn">\u26a0 ${line}</span></div>`;
    else if (line.startsWith('TRACE:')||line.startsWith('CHECK:')) html += `<div class="trace">${line}</div>`;
    else html += `<div class="line">${line}</div>`;
  });
  return html+'</div>';
}

function createRestartBtn() {
  const btn=document.createElement('button'); btn.className='ts-restart';
  btn.textContent='\u21a9 Start Over'; btn.onclick=tsRestart; return btn;
}

function truncate(s,n){ return s.length>n?s.slice(0,n)+'\u2026':s; }
function escAttr(s){ return s.replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

let sim = {
  pos: 0, k1: false, k2: false, k3: false,
  solA: false, solB: false,
  extLim: false, retLim: true,
  estop: false, jogging: null,
  cycling: false, phase: 'idle',
  animFrame: null, lastTime: 0,
};
const SIM_SPEED = 40;

function initSimulator() { simReset(); simRender(); }

function simReset() {
  sim.pos=0; sim.k1=false; sim.k2=false; sim.k3=false;
  sim.solA=false; sim.solB=false;
  sim.extLim=false; sim.retLim=true;
  sim.estop=false; sim.jogging=null;
  sim.cycling=false; sim.phase='idle';
  if(sim.animFrame) cancelAnimationFrame(sim.animFrame);
  sim.animFrame=null;
}

function simJog(dir, pressed) {
  if(sim.estop) return;
  if(pressed) {
    sim.jogging=dir;
    sim.solA=(dir==='fwd'); sim.solB=(dir==='bwd');
    startSimLoop();
  } else {
    if(sim.jogging===dir) {
      sim.jogging=null;
      if(!sim.cycling) { sim.solA=false; sim.solB=false; sim.phase='idle'; }
    }
  }
  simRender();
}

function simCycle() {
  if(sim.estop) return;
  if(sim.cycling) return;
  if(sim.retLim) {
    simSetStatus('\u26a0 Tap FWD to nudge off home first, then CYCLE');
    return;
  }
  sim.cycling=true; sim.k1=true; sim.k2=true; sim.k3=false;
  sim.solA=true; sim.solB=false; sim.phase='extending';
  startSimLoop(); simRender();
}

function simEstop() {
  sim.estop=true; sim.k1=false; sim.k2=false; sim.k3=false;
  sim.solA=false; sim.solB=false; sim.cycling=false; sim.jogging=null;
  sim.phase='estop'; simRender();
  setTimeout(()=>{ sim.estop=false; sim.phase='idle'; simRender(); }, 2000);
}

function startSimLoop() {
  if(sim.animFrame) return;
  sim.lastTime=performance.now();
  sim.animFrame=requestAnimationFrame(simTick);
}

function simTick(now) {
  const dt=(now-sim.lastTime)/1000; sim.lastTime=now;
  if(sim.estop){ sim.animFrame=null; return; }
  let moving=false;

  if(sim.jogging==='fwd'&&sim.pos<100){ sim.pos=Math.min(100,sim.pos+SIM_SPEED*dt); moving=true; }
  if(sim.jogging==='bwd'&&sim.pos>0){ sim.pos=Math.max(0,sim.pos-SIM_SPEED*dt); moving=true; }

  if(sim.cycling) {
    if(sim.phase==='extending'&&sim.solA){ sim.pos=Math.min(100,sim.pos+SIM_SPEED*dt); moving=true; }
    if(sim.phase==='retracting'&&sim.solB){ sim.pos=Math.max(0,sim.pos-SIM_SPEED*dt); moving=true; }
  }

  sim.extLim=(sim.pos>=98);
  sim.retLim=(sim.pos<=2);

  if(sim.cycling) {
    // K3 latches when extend limit closes, stays latched via seal
    if(sim.extLim && !sim.k3) {
      sim.k3=true; // K3 latches
      sim.k2=false; // K3 NC opens, killing K2
      sim.solA=false; sim.solB=true;
      sim.phase='retracting';
    }
    // K2 stays off because K3 is latched (seal holds K3 on)
    // No bounce possible

    if(sim.phase==='retracting'&&sim.retLim) {
      sim.k1=false; sim.k2=false; sim.k3=false;
      sim.solA=false; sim.solB=false;
      sim.cycling=false; sim.phase='idle';
    }
  }

  simRender();
  if(moving||sim.cycling) sim.animFrame=requestAnimationFrame(simTick);
  else sim.animFrame=null;
}

function simRender() {
  document.getElementById('sim-fwd').className='sim-btn'+(sim.jogging==='fwd'?' active-fwd':'');
  document.getElementById('sim-bwd').className='sim-btn'+(sim.jogging==='bwd'?' active-bwd':'');
  document.getElementById('sim-cycle').className='sim-btn'+(sim.cycling?' active-cycle':'');
  document.getElementById('sim-estop').className='sim-btn'+(sim.estop?' active-estop':'');

  const statusMap = {
    idle:'<span class="state">IDLE</span> \u2014 Ready',
    extending:'<span class="state">EXTENDING</span> \u2014 K1+K2 on, SOL-A firing',
    retracting:'<span class="state">RETRACTING</span> \u2014 K1+K3 on, K2 locked off, SOL-B firing',
    estop:'<span class="state" style="color:var(--red)">E-STOP</span> \u2014 All power killed',
  };
  let st=statusMap[sim.phase]||'';
  if(sim.jogging==='fwd'&&!sim.cycling) st='<span class="state">JOG FWD</span> \u2014 Manual extend';
  if(sim.jogging==='bwd'&&!sim.cycling) st='<span class="state">JOG BWD</span> \u2014 Manual retract';
  document.getElementById('sim-status').innerHTML=st;

  setSimItem('si-k1',sim.k1); setSimItem('si-k2',sim.k2); setSimItem('si-k3',sim.k3);
  setSimItem('si-sola',sim.solA); setSimItem('si-solb',sim.solB);
  setSimItem('si-extlim',sim.extLim); setSimItem('si-retlim',sim.retLim);

  document.getElementById('cyl-rod').style.width=Math.max(10,sim.pos)+'%';
  document.getElementById('cyl-retlim').className='cyl-ls'+(sim.retLim?' active':'');
  document.getElementById('cyl-extlim').className='cyl-ls'+(sim.extLim?' active':'');
}

function setSimItem(id,on){ document.getElementById(id).className='sim-item '+(on?'on':'off'); }
function simSetStatus(msg){ document.getElementById('sim-status').innerHTML=msg; }


document.addEventListener('DOMContentLoaded', () => {
  initNav();
  initInstall();
  initWiring();
  buildRelayTable(document.getElementById('k1-table'), 'K1');
  buildRelayTable(document.getElementById('k2-table'), 'K2');
  buildRelayTable(document.getElementById('k3-table'), 'K3');
  initTracer();
  initTroubleshoot();
  initSimulator();

  const fwd = document.getElementById('sim-fwd');
  const bwd = document.getElementById('sim-bwd');
  fwd.addEventListener('mousedown', () => simJog('fwd', true));
  fwd.addEventListener('mouseup', () => simJog('fwd', false));
  fwd.addEventListener('mouseleave', () => simJog('fwd', false));
  fwd.addEventListener('touchstart', e => { e.preventDefault(); simJog('fwd', true); });
  fwd.addEventListener('touchend', e => { e.preventDefault(); simJog('fwd', false); });
  bwd.addEventListener('mousedown', () => simJog('bwd', true));
  bwd.addEventListener('mouseup', () => simJog('bwd', false));
  bwd.addEventListener('mouseleave', () => simJog('bwd', false));
  bwd.addEventListener('touchstart', e => { e.preventDefault(); simJog('bwd', true); });
  bwd.addEventListener('touchend', e => { e.preventDefault(); simJog('bwd', false); });
  document.getElementById('sim-cycle').addEventListener('click', simCycle);
  document.getElementById('sim-estop').addEventListener('click', simEstop);
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
